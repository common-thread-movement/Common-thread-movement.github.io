<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Common Thread ¬∑ Field Kit</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- App icon for iOS Home Screen -->
  <link rel="apple-touch-icon" href="icons/IMG_8375.png">

  <!-- Your existing site styles -->
  <link rel="stylesheet" href="style.css">

  <style>
    .small-note { font-size: 0.85rem; opacity: 0.7; }
    .card {
      border: 1px solid #333;
      border-radius: 10px;
      padding: 0.9rem;
      margin: 0.9rem 0;
      background: rgba(0,0,0,0.22);
    }
    .row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    input[type="text"], input[type="number"] {
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #333;
      background: rgba(255,255,255,0.05);
      color: #fff;
      min-width: 220px;
      flex: 1;
    }
    textarea { width: 100%; padding: 0.55rem; border-radius: 8px; border: 1px solid #333; background: rgba(255,255,255,0.05); color:#fff; }

    /* Public/App root containers */
    #publicView { display: none; }
    #appView { display: none; }

    /* App top nav (single HTML file "pages") */
    .top-nav {
      position: sticky;
      top: 0;
      z-index: 9999;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      padding: 0.45rem;
      background: rgba(0,0,0,0.92);
      border-bottom: 1px solid #333;
    }
    .top-nav button {
      border: 1px solid #333;
      border-radius: 10px;
      padding: 0.35rem 0.55rem;
      background: rgba(255,255,255,0.06);
      color: #fff;
      opacity: 0.9;
    }
    .top-nav button.active { opacity: 1; border-color: #666; }

    .page { display: none; }
    .page.active { display: block; }

    /* Log styles */
    .log-entry { border-top: 1px solid #444; padding: 0.4rem 0; font-size: 0.9rem; }
    .log-entry-date { font-weight: bold; opacity: 0.9; }
    .log-entry-meta { opacity: 0.8; }

    .mission-card {
      border: 1px solid #444;
      padding: 0.6rem;
      border-radius: 8px;
      margin: 0.4rem 0 0.6rem 0;
      font-size: 0.95rem;
      background: rgba(0,0,0,0.25);
    }

    .quiz-question { font-weight: 600; margin-bottom: 0.5rem; }
    .quiz-options button { display: block; width: 100%; margin-bottom: 0.35rem; }

    /* Ladder result styles */
    #ctm-ladder .ladder-result {
      border: 1px solid #444;
      padding: 0.6rem;
      border-radius: 8px;
      margin-top: 0.6rem;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    #ctm-ladder .ladder-result.zone-red { border-color: #a00; background-color: rgba(160, 0, 0, 0.15); }
    #ctm-ladder .ladder-result.zone-yellow { border-color: #a78000; background-color: rgba(167, 128, 0, 0.12); }
    #ctm-ladder .ladder-result.zone-green { border-color: #0a7a2a; background-color: rgba(0, 120, 40, 0.12); }

    /* Group sync */
    .chat-box {
      border: 1px solid #333;
      border-radius: 10px;
      padding: 0.75rem;
      background: rgba(255,255,255,0.04);
    }
    .chat-stream {
      max-height: 260px;
      overflow: auto;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 0.6rem;
      background: rgba(0,0,0,0.18);
      font-size: 0.92rem;
      line-height: 1.25;
    }
    .chat-msg {
      border-top: 1px solid rgba(255,255,255,0.08);
      padding: 0.45rem 0;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .chat-msg:first-child { border-top: none; }
    .tag {
      display:inline-block;
      padding: 0.15rem 0.45rem;
      border:1px solid #333;
      border-radius: 999px;
      font-size: 0.75rem;
      opacity:0.9;
      background: rgba(255,255,255,0.05);
    }
  </style>
</head>

<body>
  <header id="top">
    <h1>Common Thread ¬∑ Field Kit</h1>
    <p>Quiet operations for responsible citizens.</p>
  </header>

  <section class="content-box">

    <!-- =====================================================
         PUBLIC VIEW (WEB-FACING)
         ONLY: Install instructions + Group code tool
    ====================================================== -->
    <div id="publicView">

      <div class="card">
        <h2>Use the Field Kit as an App</h2>
        <p class="small-note">
          Install to your Home Screen. No accounts. No tracking. Operator tools only appear in the installed app.
        </p>

        <p><strong>On iPhone / iPad:</strong><br>
          1) Open this page in Safari<br>
          2) Tap Share (square + arrow)<br>
          3) Tap <strong>Add to Home Screen</strong><br>
          4) Tap <strong>Add</strong>
        </p>

        <p><strong>On Android (Chrome):</strong><br>
          1) Open this page in Chrome<br>
          2) Tap menu (‚ãÆ)<br>
          3) Tap <strong>Install app</strong> / <strong>Add to Home screen</strong><br>
          4) Confirm
        </p>

        <p class="small-note" style="text-align:center;margin-top:.7rem;">
          After install, open from your Home Screen icon to access tools.
        </p>
      </div>

      <div class="card">
        <h2>Group Code</h2>
        <p class="small-note">
          Generate a code to share with a friend. The app remembers your last code on this device.
        </p>

        <div class="row" style="margin:.6rem 0;">
          <button type="button" onclick="generateGroupCode()">Generate Code</button>
          <button type="button" onclick="copyGroupCode()">Copy</button>
        </div>

        <div class="row">
          <input id="groupCodeDisplay" type="text" readonly placeholder="No code yet" />
          <span class="small-note" id="groupCodeMsg"></span>
        </div>

        <hr style="opacity:.25;margin:1rem 0;">

        <h3>Join a Code</h3>
        <p class="small-note">Paste a code you received. (No login. Stored locally.)</p>
        <div class="row">
          <input id="joinCodeInput" type="text" placeholder="e.g. CTM-7K4P-9Q2D" />
          <button type="button" onclick="joinGroupCode(false)">Join</button>
        </div>
        <p class="small-note" id="joinCodeMsg"></p>
      </div>

    </div>


    <!-- =====================================================
         APP VIEW (PWA MODE)
         ALL tools + docs + nav (single-file ‚Äúpages‚Äù)
    ====================================================== -->
    <div id="appView">

      <nav class="top-nav" aria-label="App navigation">
        <button type="button" data-page="page-home" class="active">Home</button>
        <button type="button" data-page="page-docs">Docs</button>
        <button type="button" data-page="page-tools">Tools</button>
        <button type="button" data-page="page-games">Games</button>
        <button type="button" data-page="page-journal">Journal</button>
        <button type="button" data-page="page-groups">Groups</button>
      </nav>

      <!-- HOME -->
      <div id="page-home" class="page active">
        <div class="card">
          <h2>Operator Status</h2>
          <p class="small-note">Everything is local to this device.</p>

          <div style="text-align:center;">
            <div style="font-size:0.85rem; opacity:0.7;">CURRENT SCORE</div>
            <div id="scoreCurrent" style="font-size:2.2rem; font-weight:bold;">0</div>

            <div style="font-size:0.85rem; opacity:0.7;">PERSONAL BEST</div>
            <div id="scoreBest" style="font-size:1.4rem; font-weight:bold;">0</div>
          </div>

          <p class="small-note" id="streakText"></p>
        </div>
      </div>

      <!-- DOCS -->
      <div id="page-docs" class="page">
        <div class="card">
          <h2>Field Documents</h2>
          <p class="small-note">Tap any document to open it.</p>
          <ul>
            <li><a href="docs/Fourpages.pdf" target="_blank" rel="noopener">CT-PRC-004 ‚Äî Principles Package (4-Page Brief)</a></li>
            <li><a href="docs/handbook.pdf" target="_blank" rel="noopener">CT-HBK-001 ‚Äî Internal Handbook (Restricted)</a></li>
            <li><a href="docs/Fieldkit.pdf" target="_blank" rel="noopener">CT-FLD-010 ‚Äî Field Kit (Operator Issue)</a></li>
          </ul>
          <p class="small-note">If PDFs don‚Äôt scroll well on iOS, open them in a new tab and pinch/scroll there.</p>
        </div>
      </div>

      <!-- TOOLS -->
      <div id="page-tools" class="page">

        <!-- ========== DAILY CIVIC POSTURE CHECKLIST ========== -->
        <div class="card">
          <h2 id="tools">Daily Civic Posture Checklist</h2>

          <form id="dailyChecklist">
            <h3>Grounding</h3>
            <label><input type="checkbox" id="grounding1"> Did I take 3 seconds before responding?</label><br>
            <label><input type="checkbox" id="grounding2"> Did I observe instead of react at least once?</label>

            <h3>Truth Discipline</h3>
            <label><input type="checkbox" id="truth1"> Did I avoid sharing anything unverified?</label><br>
            <label><input type="checkbox" id="truth2"> Did I admit "I don't know" when needed?</label><br>
            <label><input type="checkbox" id="truth3"> Did I correct myself or my "side" if wrong?</label>

            <h3>Non-Tribal Posture</h3>
            <label><input type="checkbox" id="nontribal1"> Did I disagree respectfully with someone today?</label><br>
            <label><input type="checkbox" id="nontribal2"> Did I treat people as humans, not camp avatars?</label>

            <h3>De-Escalation</h3>
            <label><input type="checkbox" id="deesc1"> Did I cool down at least one rising situation?</label><br>
            <label><input type="checkbox" id="deesc2"> Did I avoid fueling any conflict?</label>

            <h3>Quiet Uplift</h3>
            <label><input type="checkbox" id="uplift1"> Did I do one helpful act without telling anyone?</label><br>
            <label><input type="checkbox" id="uplift2"> Did I support someone quietly who needed it?</label>

            <h3>Boundary Health</h3>
            <label><input type="checkbox" id="boundary1"> Did I maintain realistic boundaries?</label><br>
            <label><input type="checkbox" id="boundary2"> Did I avoid guilt/pressure from moving me out of position?</label>

            <h3>Operator Integrity</h3>
            <label><input type="checkbox" id="integrity1"> Did I act within the law?</label><br>
            <label><input type="checkbox" id="integrity2"> Did I avoid anything harmful to the movement?</label><br>
            <label><input type="checkbox" id="integrity3"> Did I remain nonpartisan, nonviolent, grounded?</label>

            <h3>Final Self-Audit</h3>
            <label>What one thing will I improve tomorrow?</label><br>
            <textarea id="selfImprove" rows="3"></textarea>

            <br><br>
            <button type="button" onclick="saveChecklist()">Save Today's Checklist</button>
          </form>

          <p id="saveMessage" style="color:#5f5; font-weight:bold;"></p>
        </div>

        <!-- ========== BATHROOM CLEAN-UP CHECKLIST ========== -->
        <div class="card">
          <h2>Bathroom Clean-Up Checklist</h2>
          <p class="small-note">Stored only on this device.</p>
          <form id="bathroomChecklist">
            <label><input type="checkbox" id="bath_pickup"> Pick up visible trash.</label><br>
            <label><input type="checkbox" id="bath_sink"> Wipe the sink and counter.</label><br>
            <label><input type="checkbox" id="bath_mirror"> Check mirror/floor; remove obvious mess if safe.</label><br>
            <label><input type="checkbox" id="bath_state"> Leave lights/water/dispensers sane.</label><br>
            <label><input type="checkbox" id="bath_silent"> Leave without telling anyone.</label><br><br>
            <button type="button" onclick="saveBathroom()">Save Bathroom Checklist</button>
          </form>
          <p id="bathroomMessage" style="color:#5f5; font-weight:bold;"></p>
        </div>

        <!-- ========== COMMUNITY BAGS OF TRASH COUNTER ========== -->
        <div class="card">
          <h2>Community Bags of Trash</h2>
          <div style="text-align:center; margin-bottom: 0.8rem;">
            <div style="font-size:0.85rem; opacity:0.7;">TOTAL BAGS RECORDED</div>
            <div id="trashCountDisplay" style="font-size:2rem; font-weight:bold;">0</div>
            <button type="button" onclick="incrementTrash()">+1 Bag</button>
            <button type="button" onclick="decrementTrash()" style="margin-left:0.5rem;">Undo (‚Äì1)</button>
          </div>
          <p id="trashMessage" style="color:#5f5; font-weight:bold; text-align:center;"></p>
        </div>

        <!-- ========== DAILY MISSION CARD GAME ========== -->
        <div class="card">
          <h2>Daily Mission Card</h2>
          <p class="small-note">One quiet operation for today. Stored locally.</p>

          <div id="missionCard" class="mission-card">
            <span id="missionText">Tap "Draw Today‚Äôs Mission" to begin.</span>
          </div>

          <button type="button" onclick="drawMission()">Draw Today‚Äôs Mission</button>
          <button type="button" onclick="completeMission()" style="margin-left:0.5rem;">Mark Mission Complete</button>
          <p id="missionStatus" class="small-note" style="margin-top:0.4rem;"></p>
        </div>

        <!-- ========== AMYGDALA DRILL ========== -->
        <div class="card">
          <h2>Amygdala Drill ‚Äî 60-Second Reset</h2>
          <p class="small-note">One minute reset.</p>
          <div id="amygdalaStep" class="small-note" style="margin-bottom:0.4rem;">Press start when you feel the Instinct Spike.</div>
          <div id="amygdalaTimer" style="font-size:1.4rem; font-weight:bold; margin-bottom:0.4rem;">Ready</div>
          <button type="button" onclick="startAmygdala()">Start 60-second drill</button>
          <p id="amygdalaNote" class="small-note" style="margin-top:0.4rem;"></p>
        </div>

        <!-- ========== CTM LADDER OF INFERENCE ========== -->
        <div class="card">
          <h2 id="ctm-ladder-title">CTM Ladder of Inference</h2>
          <p class="small-note">
            Check boxes. Some add risk, some reduce it. Score is conservative.
          </p>

          <ol id="ctm-ladder">
            <li class="ladder-rung" data-rung="1">
              <h3>Rung 1 ‚Äì Raw Reality</h3>
              <ul class="checklist">
                <li><label><input type="checkbox" data-weight="1"> Reacting to how it felt more than what happened?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Only caught a slice (not full picture)?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Relying on memory more than observation?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Info second-hand/unverified?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Replayed exact words/actions before reacting?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Asked them to repeat to confirm?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Open to being wrong?</label></li>
              </ul>
            </li>

            <li class="ladder-rung" data-rung="2">
              <h3>Rung 2 ‚Äì Selected Data</h3>
              <ul class="checklist">
                <li><label><input type="checkbox" data-weight="1"> Fixated on emotional detail over relevant detail?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Ignored neutral/positive evidence?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Old experiences choosing what I notice?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Someone else would notice different details?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Looked for one neutral/positive fact?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Asked ‚Äúwhat am I not seeing?‚Äù</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Scanned the whole situation once?</label></li>
              </ul>
            </li>

            <li class="ladder-rung" data-rung="3">
              <h3>Rung 3 ‚Äì Meaning Added</h3>
              <ul class="checklist">
                <li><label><input type="checkbox" data-weight="1"> Assuming their intent without proof?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Turned behavior into character judgment?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Predicting future from one moment?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Linked to old wound/trauma/unrelated?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Named it as ‚Äústory in my head‚Äù?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Considered generous explanation?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Willing to change story with new info?</label></li>
              </ul>
            </li>

            <li class="ladder-rung" data-rung="4">
              <h3>Rung 4 ‚Äì Conclusions</h3>
              <ul class="checklist">
                <li><label><input type="checkbox" data-weight="1"> Treating assumption like fact?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Skipped clarifying questions?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Strong emotional surge?</label></li>
                <li><label><input type="checkbox" data-weight="1"> Would struggle to prove in court?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Asked one curious clarifying question?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Would say it in front of someone I respect?</label></li>
                <li><label><input type="checkbox" data-weight="-1"> Open to updating with solid evidence?</label></li>
              </ul>
            </li>

            <li class="ladder-rung">
              <h3>Rung 5 ‚Äì Result</h3>
              <div class="ladder-result" data-zone-display>
                <p><strong>Total score:</strong> <span data-total-score>0</span></p>
                <p><strong>Zone:</strong> <span data-zone-label>‚Äî</span></p>
                <p class="small-note" data-zone-description>Check boxes above to evaluate your state.</p>
              </div>
              <p class="small-note" style="margin-top:0.6rem;">
                üü• RED: any rung ‚â•4 OR total ‚â•6 ‚Üí do not act.<br>
                üüß YELLOW: total 1‚Äì5 ‚Üí seek clarity first.<br>
                üü© GREEN: all rungs ‚â§1 and total ‚â§2 ‚Üí safe to act.
              </p>
            </li>
          </ol>
        </div>

        <!-- ========== OPERATOR LOG ========== -->
        <div class="card">
          <h2>Operator Log</h2>
          <p class="small-note">Recent days stored locally.</p>
          <div id="logContainer"></div>
        </div>
      </div>

      <!-- GAMES -->
      <div id="page-games" class="page">
        <div class="card">
          <h2 id="games">Pattern Spotter ‚Äî Instinct Spike</h2>
          <p class="small-note">Quick drill.</p>

          <div id="quizQuestion" class="quiz-question"></div>
          <div class="quiz-options">
            <button type="button" onclick="answerQuiz(0)">Instinct Spike / tribal escalation</button>
            <button type="button" onclick="answerQuiz(1)">Grounded disagreement</button>
            <button type="button" onclick="answerQuiz(2)">Cooling / de-escalation</button>
            <button type="button" onclick="answerQuiz(3)">Neutral / factual</button>
          </div>
          <p id="quizFeedback" class="small-note" style="margin-top:0.4rem;"></p>
          <button type="button" onclick="nextQuiz()" style="margin-top:0.4rem;">New Scenario</button>
        </div>
      </div>

      <!-- JOURNAL -->
      <div id="page-journal" class="page">
        <div class="card">
          <h2 id="journalSection">Operation Journal</h2>
          <p class="small-note">Saved only on this device.</p>

          <textarea id="opJournal" rows="6"></textarea>
          <br><br>
          <button type="button" onclick="saveJournal()">Save Journal</button>
          <p id="journalMessage" style="color:#5f5; font-weight:bold;"></p>

          <hr style="opacity:.25;margin:1rem 0;">

          <h3>Saved Entries</h3>
          <p class="small-note">Last 20 shown.</p>
          <div id="journalEntries"></div>
        </div>
      </div>

      <!-- GROUPS -->
      <div id="page-groups" class="page">
        <div class="card">
          <h2>Groups</h2>
          <p class="small-note">
            Option A (HTTP): This uses <span class="tag">GET/POST /room/&lt;CODE&gt;</span> (no WebSockets).
          </p>

          <div class="row" style="margin:.6rem 0;">
            <button type="button" onclick="generateGroupCode()">Generate Code</button>
            <button type="button" onclick="copyGroupCode()">Copy</button>
            <button type="button" onclick="setActiveCodeFromMyCode()">Use My Code as Active</button>
          </div>

          <div class="row">
            <input id="groupCodeDisplay_app" type="text" readonly placeholder="No code yet" />
            <span class="small-note" id="groupCodeMsg_app"></span>
          </div>

          <hr style="opacity:.25;margin:1rem 0;">

          <h3>Join a Code</h3>
          <div class="row">
            <input id="joinCodeInput_app" type="text" placeholder="e.g. CTM-7K4P-9Q2D" />
            <button type="button" onclick="joinGroupCode(true)">Join</button>
          </div>
          <p class="small-note" id="joinCodeMsg_app"></p>

          <hr style="opacity:.25;margin:1rem 0;">
          <h3>My Joined Codes</h3>
          <div id="joinedCodesList"></div>

          <hr style="opacity:.25;margin:1rem 0;">

          <h3>Active Room</h3>
          <p class="small-note">
            The Active Room is what sync uses. Pick one of your joined codes, then connect.
          </p>

          <div class="row">
            <input id="activeRoomInput" type="text" placeholder="CTM-XXXX-XXXX" />
            <button type="button" onclick="setActiveRoom()">Set Active</button>
            <button type="button" onclick="connectRoom()">Connect</button>
            <button type="button" onclick="disconnectRoom()">Disconnect</button>
          </div>
          <p class="small-note" id="roomStatus"></p>

          <div class="chat-box" style="margin-top:0.8rem;">
            <h3>Room Feed</h3>
            <p class="small-note">
              Lightweight ‚Äúroom feed‚Äù for short notes. Polls every few seconds when connected.
            </p>
            <div id="roomStream" class="chat-stream"></div>

            <div class="row" style="margin-top:0.6rem;">
              <input id="roomNameInput" type="text" placeholder="Name (optional)" />
              <button type="button" onclick="refreshRoom()">Refresh</button>
            </div>

            <textarea id="roomMsgInput" rows="3" placeholder="Write a short note to the room..."></textarea>
            <div class="row" style="margin-top:0.5rem;">
              <button type="button" onclick="sendRoomMessage()">Send</button>
              <span class="small-note" id="sendStatus"></span>
            </div>
          </div>

        </div>
      </div>

    </div><!-- /appView -->

  </section>
  <script>
    // ============================
    // OPTION A (HTTP) CONFIG
    // ============================

    // üîí Hard-coded Worker base URL (no user edits)
    const WORKER_BASE_DEFAULT = "https://proud-leaf-609e.paulquestioner.workers.dev";

    function getWorkerBase() {
      return WORKER_BASE_DEFAULT.replace(/\/+$/,"");
    }
    function roomUrl(code) {
      const base = getWorkerBase();
      return base + "/room/" + encodeURIComponent(code);
    }

    // ----------------------------
    // Mode detection + view switch
    // ----------------------------
    function isAppMode() {
      const standaloneMatch = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
      const iosStandalone = window.navigator.standalone === true;
      return standaloneMatch || iosStandalone;
    }

    function showPublic() {
      document.getElementById("publicView").style.display = "block";
      document.getElementById("appView").style.display = "none";
    }

    function showApp() {
      document.getElementById("publicView").style.display = "none";
      document.getElementById("appView").style.display = "block";
    }

    // ----------------------------
    // App nav (single file pages)
    // ----------------------------
    function setActivePage(pageId) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      const page = document.getElementById(pageId);
      if (page) page.classList.add("active");

      document.querySelectorAll(".top-nav button").forEach(b => b.classList.remove("active"));
      const btn = document.querySelector('.top-nav button[data-page="' + pageId + '"]');
      if (btn) btn.classList.add("active");

      // Auto-connect when entering Groups tab (if active room exists)
      if (pageId === "page-groups") maybeAutoConnectGroups();
    }

    // ----------------------------
    // Group Code tool (offline/local)
    // ----------------------------
    function randChar() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // avoid confusing I/O/1/0
      return chars[Math.floor(Math.random() * chars.length)];
    }
    function makeCode() {
      // CTM-XXXX-XXXX
      let a = "", b = "";
      for (let i=0;i<4;i++) a += randChar();
      for (let i=0;i<4;i++) b += randChar();
      return "CTM-" + a + "-" + b;
    }

    function setGroupCodeUI(code, inApp) {
      const idDisplay = inApp ? "groupCodeDisplay_app" : "groupCodeDisplay";
      const idMsg = inApp ? "groupCodeMsg_app" : "groupCodeMsg";
      const el = document.getElementById(idDisplay);
      const msg = document.getElementById(idMsg);
      if (el) el.value = code || "";
      if (msg) msg.textContent = code ? "Saved." : "";
    }

    function generateGroupCode() {
      const code = makeCode();
      localStorage.setItem("ct_group_code", code);
      setGroupCodeUI(code, false);
      setGroupCodeUI(code, true);
    }

    async function copyGroupCode() {
      const code = localStorage.getItem("ct_group_code") || "";
      if (!code) return;
      try {
        await navigator.clipboard.writeText(code);
        const m1 = document.getElementById("groupCodeMsg");
        const m2 = document.getElementById("groupCodeMsg_app");
        if (m1) m1.textContent = "Copied.";
        if (m2) m2.textContent = "Copied.";
      } catch (e) {
        const el = document.getElementById("groupCodeDisplay") || document.getElementById("groupCodeDisplay_app");
        if (el) { el.focus(); el.select(); }
      }
    }

    function normalizeCode(raw) {
      return (raw || "").trim().toUpperCase().replace(/\s+/g,"");
    }

    function getJoinedCodes() {
      try {
        const raw = localStorage.getItem("ct_joined_codes");
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch(e) { return []; }
    }

    function setJoinedCodes(arr) {
      localStorage.setItem("ct_joined_codes", JSON.stringify(arr));
    }

    function renderJoinedCodes() {
      const box = document.getElementById("joinedCodesList");
      if (!box) return;
      const codes = getJoinedCodes();
      if (!codes.length) {
        box.innerHTML = "<p class='small-note'>None yet.</p>";
        return;
      }
      box.innerHTML = "";
      codes.slice().reverse().forEach(c => {
        const safeC = c.replace(/'/g,"");
        const div = document.createElement("div");
        div.className = "log-entry";
        div.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div class="log-entry-date">${safeC}</div>
            <div class="row">
              <button type="button" onclick="quickSetActive('${safeC}')">Set Active</button>
            </div>
          </div>`;
        box.appendChild(div);
      });
    }

    function joinGroupCode(inApp) {
      const inputId = inApp ? "joinCodeInput_app" : "joinCodeInput";
      const msgId = inApp ? "joinCodeMsg_app" : "joinCodeMsg";
      const input = document.getElementById(inputId);
      const msg = document.getElementById(msgId);
      const code = normalizeCode(input ? input.value : "");
      if (!msg) return;

      if (!/^CTM-[A-Z2-9]{4}-[A-Z2-9]{4}$/.test(code)) {
        msg.textContent = "Invalid code format.";
        return;
      }

      const joined = getJoinedCodes();
      if (!joined.includes(code)) joined.push(code);
      setJoinedCodes(joined);

      msg.textContent = "Joined (stored locally).";
      if (input) input.value = "";

      renderJoinedCodes();

      // convenience: auto-fill Active Room input in app
      const activeInput = document.getElementById("activeRoomInput");
      if (activeInput) activeInput.value = code;
    }

    // ============================
    // ROOM NAME (local)
    // ============================
    function getRoomName() {
      return (localStorage.getItem("ct_room_name") || "").trim();
    }
    function setRoomName(v) {
      localStorage.setItem("ct_room_name", (v || "").trim());
    }

    // ============================
    // GROUP SYNC (OPTION A HTTP)
    // ============================
    // We do NOT use WebSockets. Only fetch GET/POST.
    let roomPollTimer = null;
    let lastSeenFingerprint = "";
    let connectedRoomCode = ""; // to avoid reconnect loops

    function getActiveRoom() {
      return normalizeCode(localStorage.getItem("ct_active_room") || "");
    }
    function setActiveRoomStorage(code) {
      localStorage.setItem("ct_active_room", normalizeCode(code || ""));
    }

    function setActiveRoom() {
      const input = document.getElementById("activeRoomInput");
      const code = normalizeCode(input ? input.value : "");
      const status = document.getElementById("roomStatus");
      if (!/^CTM-[A-Z2-9]{4}-[A-Z2-9]{4}$/.test(code)) {
        if (status) status.textContent = "Active Room: invalid code format.";
        return;
      }
      setActiveRoomStorage(code);
      if (status) status.textContent = "Active Room set to " + code + ".";
      // immediate auto-connect
      connectRoom();
    }

    function quickSetActive(code) {
      const c = normalizeCode(code);
      setActiveRoomStorage(c);
      const input = document.getElementById("activeRoomInput");
      if (input) input.value = c;
      const status = document.getElementById("roomStatus");
      if (status) status.textContent = "Active Room set to " + c + ".";
      // immediate auto-connect
      connectRoom();
    }

    function setActiveCodeFromMyCode() {
      const my = normalizeCode(localStorage.getItem("ct_group_code") || "");
      if (!my) return;
      setActiveRoomStorage(my);
      const input = document.getElementById("activeRoomInput");
      if (input) input.value = my;
      const status = document.getElementById("roomStatus");
      if (status) status.textContent = "Active Room set to your generated code: " + my + ".";
      // immediate auto-connect
      connectRoom();
    }

    async function roomGET(code) {
      const url = roomUrl(code);
      const res = await fetch(url, { method: "GET", cache: "no-store" });
      const txt = await res.text();
      if (!res.ok) throw new Error(txt || ("GET failed (" + res.status + ")"));
      return txt;
    }

    async function roomPOST(code, payload) {
      const url = roomUrl(code);
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload || {})
      });
      const txt = await res.text();
      if (!res.ok) throw new Error(txt || ("POST failed (" + res.status + ")"));
      return txt;
    }

    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, ch => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[ch]));
    }

    // ‚úÖ Improved renderer: tight spacing + supports name keys
    function renderRoomStream(text) {
      const stream = document.getElementById("roomStream");
      if (!stream) return;

      const safe = (text || "").trim();
      if (!safe) {
        stream.innerHTML = "<p class='small-note'>No room data yet.</p>";
        return;
      }

      let parsed = null;
      try { parsed = JSON.parse(safe); } catch(e) {}

      function pickName(m) {
        return (m && (m.name || m.user || m.from || m.n || m.handle)) ? String(m.name || m.user || m.from || m.n || m.handle).trim() : "";
      }
      function pickText(m) {
        return (m && (m.text || m.message || m.msg || m.body)) ? String(m.text || m.message || m.msg || m.body) : "";
      }
      function pickTime(m) {
        const t = m && (m.t || m.time || m.ts || m.date);
        if (!t) return "";
        const d = new Date(t);
        return isNaN(d.getTime()) ? "" : d.toLocaleString();
      }

      let msgs = null;
      if (parsed && typeof parsed === "object") {
        if (Array.isArray(parsed)) msgs = parsed;
        else if (Array.isArray(parsed.messages)) msgs = parsed.messages;
      }

      if (Array.isArray(msgs)) {
        stream.innerHTML = "";

        msgs.forEach(m => {
          const name = pickName(m) || "Anon";
          const when = pickTime(m);
          const body = pickText(m);

          const wrap = document.createElement("div");
          wrap.className = "chat-msg";

          const meta = document.createElement("div");
          meta.className = "chat-msg-meta";
          meta.textContent = when ? `${name} ‚Ä¢ ${when}` : name;

          const msg = document.createElement("div");
          msg.className = "chat-msg-body";
          msg.textContent = body;

          wrap.appendChild(meta);
          wrap.appendChild(msg);
          stream.appendChild(wrap);
        });

        stream.scrollTop = stream.scrollHeight;
        return;
      }

      if (parsed && typeof parsed === "object") {
        stream.innerHTML = "<pre style='white-space:pre-wrap;margin:0;'>" + escapeHtml(JSON.stringify(parsed, null, 2)) + "</pre>";
        return;
      }
      stream.innerHTML = "<pre style='white-space:pre-wrap;margin:0;'>" + escapeHtml(safe) + "</pre>";
    }

    async function refreshRoom() {
      const status = document.getElementById("roomStatus");
      const code = getActiveRoom() || normalizeCode((document.getElementById("activeRoomInput")||{}).value || "");
      if (!/^CTM-[A-Z2-9]{4}-[A-Z2-9]{4}$/.test(code)) {
        if (status) status.textContent = "Set a valid Active Room code first.";
        return;
      }

      try {
        if (status) status.textContent = "Fetching room...";
        const data = await roomGET(code);

        const fp = String(data).length + ":" + String(data).slice(0,120);
        if (fp !== lastSeenFingerprint) {
          lastSeenFingerprint = fp;
          renderRoomStream(data);
        }

        if (status) status.textContent =
          "Connected to " + code + " (last refresh: " + new Date().toLocaleTimeString() + ")";
      } catch (e) {
        if (status) status.textContent = "Room error: " + (e && e.message ? e.message : String(e));
      }
    }

    function connectRoom() {
      const status = document.getElementById("roomStatus");
      const code = getActiveRoom() || normalizeCode((document.getElementById("activeRoomInput")||{}).value || "");
      if (!/^CTM-[A-Z2-9]{4}-[A-Z2-9]{4}$/.test(code)) {
        if (status) status.textContent = "Set a valid Active Room code first.";
        return;
      }
      setActiveRoomStorage(code);

      // already polling this room
      if (connectedRoomCode === code && roomPollTimer) {
        refreshRoom();
        return;
      }

      connectedRoomCode = code;

      if (roomPollTimer) clearInterval(roomPollTimer);
      roomPollTimer = setInterval(refreshRoom, 3500);

      if (status) status.textContent = "Connecting to " + code + "...";
      refreshRoom();
    }

    function disconnectRoom() {
      const status = document.getElementById("roomStatus");
      if (roomPollTimer) clearInterval(roomPollTimer);
      roomPollTimer = null;
      connectedRoomCode = "";
      if (status) status.textContent = "Disconnected.";
    }

    function maybeAutoConnectGroups() {
      const code = getActiveRoom();
      if (!code) return;
      // connect if not connected
      if (!roomPollTimer || connectedRoomCode !== code) connectRoom();
    }

    async function sendRoomMessage() {
      const code = getActiveRoom();
      const sendStatus = document.getElementById("sendStatus");
      const status = document.getElementById("roomStatus");
      const msgEl = document.getElementById("roomMsgInput");
      const nameEl = document.getElementById("roomNameInput");

      const text = (msgEl ? msgEl.value : "").trim();
      const nameTyped = (nameEl ? nameEl.value : "").trim();
      const name = nameTyped || getRoomName(); // ‚úÖ use stored name if field empty

      if (!code) {
        if (status) status.textContent = "Set Active Room first.";
        return;
      }
      if (!text) {
        if (sendStatus) sendStatus.textContent = "Write a message first.";
        return;
      }

      // persist name if user typed it
      if (nameTyped) setRoomName(nameTyped);

      try {
        if (sendStatus) sendStatus.textContent = "Sending...";
        await roomPOST(code, {
          name: name || undefined,
          text,
          t: new Date().toISOString()
        });
        if (sendStatus) sendStatus.textContent = "Sent.";
        if (msgEl) msgEl.value = "";
        refreshRoom();
      } catch (e) {
        if (sendStatus) sendStatus.textContent = "Send failed: " + (e && e.message ? e.message : String(e));
      }
    }

    // ----------------------------
    // EXISTING TOOL LOGIC (yours)
    // ----------------------------
    const checklistFields = [
      "grounding1","grounding2",
      "truth1","truth2","truth3",
      "nontribal1","nontribal2",
      "deesc1","deesc2",
      "uplift1","uplift2",
      "boundary1","boundary2",
      "integrity1","integrity2","integrity3",
      "selfImprove"
    ];
    const checkboxFields = checklistFields.slice(0,16);

    const MISSIONS = [
      "Pick up trash in a spot that bothers you and leave without posting about it.",
      "Defend someone you disagree with from unfair treatment or mockery.",
      "Ask one person a curious question instead of arguing your point.",
      "Quietly fix or clean one thing nobody asked you to touch.",
      "Clarify someone‚Äôs position before you criticize it: repeat it back fairly first.",
      "Offer a sincere compliment to someone outside your usual circle or tribe.",
      "De-escalate one tense moment by lowering your tone and pace.",
      "Admit one small fault today without blame-shifting or excuse.",
      "Choose not to share one piece of outrage content you normally would.",
      "Support someone‚Äôs good idea even if they‚Äôre from a different camp than you."
    ];

    const AMYGDALA_STEPS = [
      "0‚Äì15s: Notice what you‚Äôre feeling. Name it without judging it.",
      "15‚Äì30s: Notice where you feel it in your body. Just observe.",
      "30‚Äì45s: Ask: What would my best self want to do here?",
      "45‚Äì60s: Choose one small, grounded action you can take next."
    ];
    let amygdalaInterval = null;

    const QUIZ_QUESTIONS = [
      { text: "\"Those people are destroying everything.\"", correct: 0, explanation: "Instinct Spike / tribal escalation." },
      { text: "\"I don‚Äôt like this policy because I think it harms working families.\"", correct: 1, explanation: "Grounded disagreement." },
      { text: "\"From their point of view, this actually makes sense even if I disagree.\"", correct: 2, explanation: "Cooling language." },
      { text: "\"The report says turnout increased by 7% this year.\"", correct: 3, explanation: "Neutral / factual." },
      { text: "\"Anyone who disagrees with this is either stupid or evil.\"", correct: 0, explanation: "Instinct Spike generalization." },
      { text: "\"I‚Äôm angry, but I want to understand what you were trying to do.\"", correct: 2, explanation: "Cooling / de-escalation." },
      { text: "\"They always play the victim.\"", correct: 0, explanation: "Instinct Spike generalization." },
      { text: "\"Here‚Äôs what I heard you say; tell me if I‚Äôm missing anything.\"", correct: 2, explanation: "Cooling posture." }
    ];
    let currentQuizIndex = -1;

    function todayKey() { return new Date().toISOString().slice(0,10); }

    function getLog() {
      try {
        const raw = localStorage.getItem("ct_log");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) { return []; }
    }
    function setLog(entries) { localStorage.setItem("ct_log", JSON.stringify(entries)); }

    function upsertTodayLog(score) {
      const date = todayKey();
      const bags = parseInt(localStorage.getItem("trashBags") || "0", 10);
      const noteEl = document.getElementById("selfImprove");
      const note = noteEl ? noteEl.value.trim() : "";
      let log = getLog();
      const idx = log.findIndex(e => e.date === date);
      const entry = { date, score, bags, note };
      if (idx >= 0) log[idx] = entry; else log.push(entry);
      log.sort((a, b) => a.date.localeCompare(b.date));
      if (log.length > 30) log = log.slice(log.length - 30);
      setLog(log);
    }

    function computeStreakFromLog(log) {
      if (!log.length) return 0;
      const map = {}; log.forEach(e => { map[e.date] = e.score; });
      let streak = 0;
      let cursor = new Date(todayKey());
      while (true) {
        const key = cursor.toISOString().slice(0,10);
        if (!map[key] || map[key] <= 0) break;
        streak += 1;
        cursor.setDate(cursor.getDate() - 1);
      }
      return streak;
    }

    function renderLog() {
      const container = document.getElementById("logContainer");
      if (!container) return;
      const log = getLog().slice().sort((a, b) => b.date.localeCompare(a.date));
      if (!log.length) { container.innerHTML = "<p class='small-note'>No entries yet.</p>"; return; }
      const recent = log.slice(0, 14);
      container.innerHTML = "";
      recent.forEach(entry => {
        const div = document.createElement("div");
        div.className = "log-entry";
        const dateEl = document.createElement("div");
        dateEl.className = "log-entry-date";
        dateEl.textContent = entry.date;
        const metaEl = document.createElement("div");
        metaEl.className = "log-entry-meta";
        metaEl.textContent = "Score: " + entry.score + " ¬∑ Bags: " + entry.bags;
        div.appendChild(dateEl);
        div.appendChild(metaEl);
        if (entry.note) {
          const noteEl = document.createElement("div");
          noteEl.textContent = "Tomorrow: " + entry.note;
          div.appendChild(noteEl);
        }
        container.appendChild(div);
      });
    }

    function renderStreak() {
      const streakText = document.getElementById("streakText");
      if (!streakText) return;
      const streak = computeStreakFromLog(getLog());
      streakText.textContent = "Current streak: " + streak + (streak === 1 ? " day." : " days.");
    }

    function computeScore() {
      let score = 0;
      checkboxFields.forEach(id => { const el = document.getElementById(id); if (el && el.checked) score += 1; });
      const text = document.getElementById("selfImprove");
      if (text && text.value.trim().length > 0) score += 1;
      const bags = parseInt(localStorage.getItem("trashBags") || "0", 10);
      score += bags;
      const missionDone = localStorage.getItem("ct_mission_done") === "true";
      if (missionDone) score += 1;
      return score;
    }

    function saveChecklist() {
      checklistFields.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === "checkbox") localStorage.setItem("ct_" + id, el.checked);
        else localStorage.setItem("ct_" + id, el.value);
      });

      const score = computeScore();
      localStorage.setItem("ct_score_today", score);

      let best = parseInt(localStorage.getItem("ct_score_best") || "0", 10);
      if (score > best) { best = score; localStorage.setItem("ct_score_best", best); }

      const sc = document.getElementById("scoreCurrent"); if (sc) sc.innerText = score;
      const sb = document.getElementById("scoreBest"); if (sb) sb.innerText = best;

      upsertTodayLog(score);
      renderLog();
      renderStreak();

      const msg = document.getElementById("saveMessage");
      if (msg) msg.innerText = (score === best) ? "Checklist saved ‚úî New personal best." : "Checklist saved ‚úî";
    }

    function saveBathroom() {
      ["bath_pickup","bath_sink","bath_mirror","bath_state","bath_silent"].forEach(id => {
        const el = document.getElementById(id);
        if (el) localStorage.setItem("ct_" + id, el.checked);
      });
      const msg = document.getElementById("bathroomMessage");
      if (msg) msg.innerText = "Bathroom checklist saved ‚úî";
    }

    function loadBathroom() {
      ["bath_pickup","bath_sink","bath_mirror","bath_state","bath_silent"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.checked = localStorage.getItem("ct_" + id) === "true";
      });
    }

    function getTrashCount() { return parseInt(localStorage.getItem("trashBags") || "0", 10); }
    function setTrashCount(value) {
      if (value < 0) value = 0;
      localStorage.setItem("trashBags", value);
      const display = document.getElementById("trashCountDisplay");
      if (display) display.innerText = value;
      const msg = document.getElementById("trashMessage");
      if (msg) msg.innerText = "Updated ‚úî";
    }
    function incrementTrash() { setTrashCount(getTrashCount() + 1); }
    function decrementTrash() { setTrashCount(getTrashCount() - 1); }

    function loadMissionFromStorage() {
      const date = localStorage.getItem("ct_mission_date");
      const text = localStorage.getItem("ct_mission_text");
      const done = localStorage.getItem("ct_mission_done") === "true";
      const today = todayKey();
      const missionTextEl = document.getElementById("missionText");
      const missionStatusEl = document.getElementById("missionStatus");
      if (!missionTextEl || !missionStatusEl) return;

      if (date === today && text) {
        missionTextEl.textContent = text;
        missionStatusEl.textContent = done ? "Mission marked complete for today." : "";
      } else {
        localStorage.removeItem("ct_mission_date");
        localStorage.removeItem("ct_mission_text");
        localStorage.removeItem("ct_mission_done");
        missionTextEl.textContent = 'Tap "Draw Today‚Äôs Mission" to begin.';
        missionStatusEl.textContent = "";
      }
    }

    function drawMission() {
      const today = todayKey();
      const randomIndex = Math.floor(Math.random() * MISSIONS.length);
      const text = MISSIONS[randomIndex];
      localStorage.setItem("ct_mission_date", today);
      localStorage.setItem("ct_mission_text", text);
      localStorage.setItem("ct_mission_done", "false");

      const mt = document.getElementById("missionText"); if (mt) mt.textContent = text;
      const ms = document.getElementById("missionStatus"); if (ms) ms.textContent = "Mission set for today.";

      const score = computeScore();
      localStorage.setItem("ct_score_today", score);
      const sc = document.getElementById("scoreCurrent"); if (sc) sc.innerText = score;
    }

    function completeMission() {
      const date = localStorage.getItem("ct_mission_date");
      const today = todayKey();
      const ms = document.getElementById("missionStatus");
      if (date !== today) { if (ms) ms.textContent = "Draw today‚Äôs mission first."; return; }

      localStorage.setItem("ct_mission_done", "true");
      if (ms) ms.textContent = "Mission marked complete for today.";

      const score = computeScore();
      localStorage.setItem("ct_score_today", score);

      let best = parseInt(localStorage.getItem("ct_score_best") || "0", 10);
      if (score > best) { best = score; localStorage.setItem("ct_score_best", best); }

      const sc = document.getElementById("scoreCurrent"); if (sc) sc.innerText = score;
      const sb = document.getElementById("scoreBest"); if (sb) sb.innerText = best;

      upsertTodayLog(score);
      renderLog();
      renderStreak();
    }

    function updateAmygdalaStep(remaining) {
      const stepEl = document.getElementById("amygdalaStep");
      if (!stepEl) return;
      if (remaining > 45) stepEl.textContent = AMYGDALA_STEPS[0];
      else if (remaining > 30) stepEl.textContent = AMYGDALA_STEPS[1];
      else if (remaining > 15) stepEl.textContent = AMYGDALA_STEPS[2];
      else stepEl.textContent = AMYGDALA_STEPS[3];
    }

    function startAmygdala() {
      const timerEl = document.getElementById("amygdalaTimer");
      const noteEl = document.getElementById("amygdalaNote");
      if (!timerEl) return;

      if (amygdalaInterval) clearInterval(amygdalaInterval);

      let remaining = 60;
      timerEl.textContent = remaining + "s";
      updateAmygdalaStep(remaining);
      if (noteEl) noteEl.textContent = "Timer runs quietly. When it ends, choose one grounded action.";

      amygdalaInterval = setInterval(function() {
        remaining--;
        if (remaining <= 0) {
          clearInterval(amygdalaInterval);
          amygdalaInterval = null;
          timerEl.textContent = "Done.";
          const stepEl = document.getElementById("amygdalaStep");
          if (stepEl) stepEl.textContent = "Notice what changed. Log it if needed.";
          if (noteEl) noteEl.textContent = "If helpful, write a note in your journal.";
        } else {
          timerEl.textContent = remaining + "s";
          updateAmygdalaStep(remaining);
        }
      }, 1000);
    }

    function renderQuizQuestion() {
      const qEl = document.getElementById("quizQuestion");
      const feedbackEl = document.getElementById("quizFeedback");
      if (!qEl || !feedbackEl) return;

      if (currentQuizIndex < 0 || currentQuizIndex >= QUIZ_QUESTIONS.length) {
        qEl.textContent = 'Tap "New Scenario" to start a drill.';
        feedbackEl.textContent = "";
        return;
      }
      const q = QUIZ_QUESTIONS[currentQuizIndex];
      qEl.textContent = q.text;
      feedbackEl.textContent = "";
    }

    function nextQuiz() {
      currentQuizIndex = Math.floor(Math.random() * QUIZ_QUESTIONS.length);
      renderQuizQuestion();
    }

    function answerQuiz(choiceIndex) {
      if (currentQuizIndex < 0 || currentQuizIndex >= QUIZ_QUESTIONS.length) return;
      const q = QUIZ_QUESTIONS[currentQuizIndex];
      const feedbackEl = document.getElementById("quizFeedback");
      if (!feedbackEl) return;

      if (choiceIndex === q.correct) feedbackEl.textContent = "Correct. " + q.explanation;
      else feedbackEl.textContent = "Not quite. " + q.explanation;
    }

    function saveJournal() {
      const el = document.getElementById("opJournal");
      if (!el) return;
      const fullText = el.value;
      const trimmed = fullText.trim();
      localStorage.setItem("ct_journal", fullText);

      if (trimmed.length > 0) {
        let entries = [];
        try {
          const raw = localStorage.getItem("ct_journal_entries");
          entries = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(entries)) entries = [];
        } catch (e) { entries = []; }

        entries.push({ date: new Date().toISOString(), text: trimmed });
        if (entries.length > 50) entries = entries.slice(entries.length - 50);
        localStorage.setItem("ct_journal_entries", JSON.stringify(entries));
      }

      const msg = document.getElementById("journalMessage");
      if (msg) msg.innerText = "Journal saved ‚úî";
      renderJournalEntries();
    }

    function loadJournal() {
      const el = document.getElementById("opJournal");
      if (!el) return;
      const stored = localStorage.getItem("ct_journal");
      if (stored !== null) el.value = stored;
    }

    function renderJournalEntries() {
      const container = document.getElementById("journalEntries");
      if (!container) return;

      let entries = [];
      try {
        const raw = localStorage.getItem("ct_journal_entries");
        entries = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(entries)) entries = [];
      } catch (e) { entries = []; }

      if (!entries.length) {
        container.innerHTML = "<p class='small-note'>No saved entries yet.</p>";
        return;
      }

      const recent = entries.slice().reverse().slice(0, 20);
      container.innerHTML = "";
      recent.forEach(entry => {
        const wrapper = document.createElement("div");
        wrapper.className = "log-entry";

        const dateEl = document.createElement("div");
        dateEl.className = "log-entry-date";
        dateEl.textContent = new Date(entry.date).toLocaleString();

        const textEl = document.createElement("div");
        textEl.className = "log-entry-meta";
        textEl.textContent = entry.text;

        wrapper.appendChild(dateEl);
        wrapper.appendChild(textEl);
        container.appendChild(wrapper);
      });
    }

    // Ladder scoring
    function initLadder() {
      const ladder = document.getElementById("ctm-ladder");
      if (!ladder) return;

      const checkboxes = ladder.querySelectorAll('input[type="checkbox"]');
      const totalScoreEl = ladder.querySelector("[data-total-score]");
      const zoneLabelEl = ladder.querySelector("[data-zone-label]");
      const zoneDescriptionEl = ladder.querySelector("[data-zone-description]");
      const zoneDisplay = ladder.querySelector("[data-zone-display]");

      function updateLadderScore() {
        const rungEls = ladder.querySelectorAll(".ladder-rung[data-rung]");
        let total = 0;
        const rungScores = [];

        rungEls.forEach(function(rungEl, index) {
          let rungScore = 0;
          rungEl.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
            if (cb.checked) {
              const w = parseFloat(cb.getAttribute("data-weight"));
              rungScore += isNaN(w) ? 1 : w;
            }
          });
          rungScores[index] = rungScore;
          total += rungScore;
        });

        const anyRungFourOrMore = rungScores.some(s => s >= 4);
        const allRungsLow = rungScores.length > 0 && rungScores.every(s => s <= 1);

        let zone = "‚Äî";
        let description = "Check boxes above to evaluate your state.";
        let zoneClass = "";

        if (anyRungFourOrMore || total >= 6) {
          zone = "üü• RED ‚Äì NO ACTION";
          description = "Do not act. Pause, gather missing data, re-run later.";
          zoneClass = "zone-red";
        } else if (allRungsLow && total <= 2) {
          zone = "üü© GREEN ‚Äì Clear to Act";
          description = "Likely seeing clearly. Act slowly and honestly.";
          zoneClass = "zone-green";
        } else if (total !== 0) {
          zone = "üüß YELLOW ‚Äì Seek Clarity First";
          description = "Ask clarifying questions. Delay emotional/public action.";
          zoneClass = "zone-yellow";
        }

        if (totalScoreEl) totalScoreEl.textContent = total.toString();
        if (zoneLabelEl) zoneLabelEl.textContent = zone;
        if (zoneDescriptionEl) zoneDescriptionEl.textContent = description;

        if (zoneDisplay) {
          zoneDisplay.classList.remove("zone-red", "zone-yellow", "zone-green");
          if (zoneClass) zoneDisplay.classList.add(zoneClass);
        }
      }

      checkboxes.forEach(cb => cb.addEventListener("change", updateLadderScore));
      updateLadderScore();
    }

    // ----------------------------
    // DOM Ready
    // ----------------------------
    document.addEventListener("DOMContentLoaded", function() {
      const inApp = isAppMode();
      if (inApp) showApp(); else showPublic();

      // wire nav only when app shown
      const nav = document.querySelector(".top-nav");
      if (nav) {
        nav.addEventListener("click", function(e) {
          const btn = e.target.closest("button[data-page]");
          if (!btn) return;
          setActivePage(btn.getAttribute("data-page"));
        });
      }

      // Restore group code in both views
      const savedCode = localStorage.getItem("ct_group_code") || "";
      if (savedCode) {
        setGroupCodeUI(savedCode, false);
        setGroupCodeUI(savedCode, true);
      }
      renderJoinedCodes();

      // Restore Active Room
      const ar = getActiveRoom();
      const arInput = document.getElementById("activeRoomInput");
      if (arInput && ar) arInput.value = ar;

      // Restore / persist room name
      const rn = getRoomName();
      const rnInput = document.getElementById("roomNameInput");
      if (rnInput) {
        if (rn) rnInput.value = rn;
        rnInput.addEventListener("input", () => setRoomName(rnInput.value));
      }

      // Load checklist fields
      checklistFields.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const stored = localStorage.getItem("ct_" + id);
        if (el.type === "checkbox") el.checked = stored === "true";
        else el.value = stored || "";
      });

      loadBathroom();

      const trashCount = localStorage.getItem("trashBags");
      if (trashCount !== null) {
        const display = document.getElementById("trashCountDisplay");
        if (display) display.innerText = trashCount;
      }

      const savedScore = localStorage.getItem("ct_score_today");
      const savedBest = localStorage.getItem("ct_score_best");
      const sc = document.getElementById("scoreCurrent");
      const sb = document.getElementById("scoreBest");
      if (savedScore && sc) sc.innerText = savedScore;
      if (savedBest && sb) sb.innerText = savedBest;

      loadMissionFromStorage();
      renderLog();
      renderStreak();
      loadJournal();
      renderJournalEntries();
      renderQuizQuestion();
      initLadder();

      // Auto-connect immediately if app loads on Groups tab later
      if (document.getElementById("page-groups")?.classList.contains("active")) {
        maybeAutoConnectGroups();
      }

      // Register service worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js").catch(function() {});
      }
    });
  </script>
</body>
</html>
