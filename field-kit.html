<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Common Thread · Field Kit</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- App icon for iOS Home Screen -->
  <link rel="apple-touch-icon" href="icons/IMG_8375.png">

  <!-- Your existing site styles -->
  <link rel="stylesheet" href="style.css">

  <style>
    /* Hide private tools by default */
    .private-section {
      display: none;
    }

    .small-note {
      font-size: 0.8rem;
      opacity: 0.65;
    }

    .log-entry {
      border-top: 1px solid #444;
      padding: 0.4rem 0;
      font-size: 0.85rem;
    }
    .log-entry-date {
      font-weight: bold;
      opacity: 0.9;
    }
    .log-entry-meta {
      opacity: 0.8;
    }

    /* PDF overlay for app mode */
    #pdfOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      overflow: hidden; /* keep scrolling inside the frame */
    }
    #pdfClose {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #111;
      color: #fff;
      cursor: pointer;
      z-index: 10000;
    }
    #pdfFrame {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      border: none;
      background: #222;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>

<body>

  <header>
    <h1>Common Thread · Field Kit</h1>
    <p>Quiet operations for responsible citizens.</p>
  </header>

  <section class="content-box">

    <!-- ========== DOCUMENT LINKS ========== -->
    <h2>Field Documents</h2>
    <p style="margin-bottom: 0.5rem;">Tap any document below to open it:</p>

    <ul>
      <li>
        <a href="docs/Fourpages.pdf"
           target="_blank"
           class="doc-link"
           data-doc="docs/Fourpages.pdf">
          CT-PRC-004 — Principles Package (4-Page Brief)
        </a>
      </li>
      <li>
        <a href="docs/handbook.pdf"
           target="_blank"
           class="doc-link"
           data-doc="docs/handbook.pdf">
          CT-HBK-001 — Internal Handbook (Restricted)
        </a>
      </li>
      <li>
        <a href="docs/Fieldkit.pdf"
           target="_blank"
           class="doc-link"
           data-doc="docs/Fieldkit.pdf">
          CT-FLD-010 — Field Kit (Operator Issue)
        </a>
      </li>
    </ul>

    <!-- ========== DIRECTIONS SECTION FOR INSTALLING APP ========== -->
    <hr>

    <h2>Use the Field Kit as an App</h2>

    <p class="small-note">
      Installing this page to your Home Screen lets the operator tools run like a quiet, offline app.
      All data stays on your device.
    </p>

    <p>
      <strong>On iPhone / iPad:</strong><br>
      1. Open this page in Safari.<br>
      2. Tap the <em>Share</em> icon (square with the arrow).<br>
      3. Scroll down and tap <strong>Add to Home Screen</strong>.<br>
      4. Tap <strong>Add</strong>. Use the new icon to open the Field Kit.
    </p>

    <p>
      <strong>On Android (Chrome):</strong><br>
      1. Open this page in Chrome.<br>
      2. Tap the menu (⋮) in the top-right corner.<br>
      3. Tap <strong>Add to Home screen</strong> or <strong>Install app</strong>.<br>
      4. Confirm. Use the new icon to open the Field Kit.
    </p>

    <p id="publicHint" class="small-note" style="margin-top:1rem; text-align:center;">
      Operator tools are available when opened from your Home Screen as an app.
    </p>

    <!-- ========== PRIVATE OPERATOR TOOLS (HIDDEN ON NORMAL WEBSITE) ========== -->
    <div class="private-section" id="privateTools">

      <hr>

      <!-- ========== DAILY CIVIC POSTURE CHECKLIST ========== -->
      <h2>Daily Civic Posture Checklist</h2>

      <form id="dailyChecklist">

        <h3>Grounding</h3>
        <label><input type="checkbox" id="grounding1"> Did I take 3 seconds before responding?</label><br>
        <label><input type="checkbox" id="grounding2"> Did I observe instead of react at least once?</label>

        <h3>Truth Discipline</h3>
        <label><input type="checkbox" id="truth1"> Did I avoid sharing anything unverified?</label><br>
        <label><input type="checkbox" id="truth2"> Did I admit “I don’t know” when needed?</label><br>
        <label><input type="checkbox" id="truth3"> Did I correct myself or my “side” if wrong?</label>

        <h3>Non-Tribal Posture</h3>
        <label><input type="checkbox" id="nontribal1"> Did I disagree respectfully with someone today?</label><br>
        <label><input type="checkbox" id="nontribal2"> Did I treat people as humans, not camp avatars?</label>

        <h3>De-Escalation</h3>
        <label><input type="checkbox" id="deesc1"> Did I cool down at least one rising situation?</label><br>
        <label><input type="checkbox" id="deesc2"> Did I avoid fueling any conflict?</label>

        <h3>Quiet Uplift</h3>
        <label><input type="checkbox" id="uplift1"> Did I do one helpful act without telling anyone?</label><br>
        <label><input type="checkbox" id="uplift2"> Did I support someone quietly who needed it?</label>

        <h3>Boundary Health</h3>
        <label><input type="checkbox" id="boundary1"> Did I maintain realistic boundaries?</label><br>
        <label><input type="checkbox" id="boundary2"> Did I avoid guilt/pressure from moving me out of position?</label>

        <h3>Operator Integrity</h3>
        <label><input type="checkbox" id="integrity1"> Did I act within the law?</label><br>
        <label><input type="checkbox" id="integrity2"> Did I avoid anything harmful to the movement?</label><br>
        <label><input type="checkbox" id="integrity3"> Did I remain nonpartisan, nonviolent, grounded?</label>

        <h3>Final Self-Audit</h3>
        <label>What one thing will I improve tomorrow?</label><br>
        <textarea id="selfImprove" rows="3" style="width:100%;"></textarea>

        <br><br>
        <button type="button" onclick="saveChecklist()">Save Today’s Checklist</button>
      </form>

      <p id="saveMessage" style="color:#5f5; font-weight:bold;"></p>

      <hr>

      <!-- ========== COMMUNITY BAGS OF TRASH COUNTER ========== -->
      <h2>Community Bags of Trash</h2>

      <div style="text-align:center; margin-bottom: 1rem;">
        <div style="font-size:0.85rem; opacity:0.7;">TOTAL BAGS RECORDED</div>
        <div id="trashCountDisplay" style="font-size:2rem; font-weight:bold;">0</div>
        <button onclick="incrementTrash()">+1 Bag</button>
        <button onclick="decrementTrash()" style="margin-left:0.5rem;">Undo (–1)</button>
      </div>

      <p id="trashMessage" style="color:#5f5; font-weight:bold; text-align:center;"></p>

      <hr>

      <!-- ========== DAILY SCORE ========== -->
      <h2>Today’s Score</h2>

      <div style="text-align:center;">
        <div style="font-size:0.85rem; opacity:0.7;">CURRENT SCORE</div>
        <div id="scoreCurrent" style="font-size:2.2rem; font-weight:bold;">0</div>

        <div style="font-size:0.85rem; opacity:0.7;">PERSONAL BEST</div>
        <div id="scoreBest" style="font-size:1.4rem; font-weight:bold;">0</div>
      </div>

      <hr>

      <!-- ========== OPERATOR LOG + STREAK ========== -->
      <h2>Operator Log</h2>
      <p class="small-note">
        Local record of recent days: score, bags, and tomorrow’s focus. Stored only on this device.
      </p>

      <p class="small-note" id="streakText"></p>

      <div id="logContainer"></div>

      <hr>

      <!-- ========== OPERATION JOURNAL ========== -->
      <h2>Operation Journal</h2>
      <p class="small-note">
        Free-form notes on conversations, situations, and observations. Saved only on this device.
      </p>

      <textarea id="opJournal" rows="6" style="width:100%;"></textarea>
      <br><br>
      <button type="button" onclick="saveJournal()">Save Journal</button>
      <p id="journalMessage" style="color:#5f5; font-weight:bold;"></p>

    </div> <!-- END PRIVATE SECTION -->

  </section>

  <!-- PDF OVERLAY (APP MODE ONLY) -->
  <div id="pdfOverlay">
    <button id="pdfClose">Close</button>
    <iframe id="pdfFrame" src=""></iframe>
  </div>

  <!-- ========== SCRIPT ========== -->
  <script>
    // Determine if running as installed app (iOS + general)
    function isAppMode() {
      const standaloneMatch = window.matchMedia &&
        window.matchMedia('(display-mode: standalone)').matches;
      const iosStandalone = window.navigator.standalone === true;
      return standaloneMatch || iosStandalone;
    }

    // Checklist items
    const checklistFields = [
      "grounding1","grounding2",
      "truth1","truth2","truth3",
      "nontribal1","nontribal2",
      "deesc1","deesc2",
      "uplift1","uplift2",
      "boundary1","boundary2",
      "integrity1","integrity2","integrity3",
      "selfImprove"
    ];
    const checkboxFields = checklistFields.slice(0,16); // first 16 are checkboxes

    function todayKey() {
      return new Date().toISOString().slice(0,10); // YYYY-MM-DD
    }

    function getLog() {
      try {
        const raw = localStorage.getItem("ct_log");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        return [];
      }
    }

    function setLog(entries) {
      localStorage.setItem("ct_log", JSON.stringify(entries));
    }

    function upsertTodayLog(score) {
      const date = todayKey();
      const bags = parseInt(localStorage.getItem("trashBags") || "0", 10);
      const noteEl = document.getElementById("selfImprove");
      const note = noteEl ? noteEl.value.trim() : "";

      let log = getLog();
      const idx = log.findIndex(e => e.date === date);
      const entry = { date, score, bags, note };

      if (idx >= 0) log[idx] = entry;
      else log.push(entry);

      log.sort((a, b) => a.date.localeCompare(b.date));

      if (log.length > 30) {
        log = log.slice(log.length - 30);
      }

      setLog(log);
    }

    function computeStreakFromLog(log) {
      if (!log.length) return 0;

      const map = {};
      log.forEach(e => { map[e.date] = e.score; });

      let streak = 0;
      let cursor = new Date(todayKey());

      while (true) {
        const key = cursor.toISOString().slice(0,10);
        if (!map[key] || map[key] <= 0) break;
        streak += 1;
        cursor.setDate(cursor.getDate() - 1);
      }

      return streak;
    }

    function renderLog() {
      const container = document.getElementById("logContainer");
      if (!container) return;

      const log = getLog().slice().sort((a, b) => b.date.localeCompare(a.date));

      if (!log.length) {
        container.innerHTML = "<p class='small-note'>No entries yet.</p>";
        return;
      }

      const recent = log.slice(0, 14);
      container.innerHTML = "";
      recent.forEach(entry => {
        const div = document.createElement("div");
        div.className = "log-entry";

        const dateEl = document.createElement("div");
        dateEl.className = "log-entry-date";
        dateEl.textContent = entry.date;

        const metaEl = document.createElement("div");
        metaEl.className = "log-entry-meta";
        metaEl.textContent = "Score: " + entry.score + " · Bags: " + entry.bags;

        div.appendChild(dateEl);
        div.appendChild(metaEl);

        if (entry.note) {
          const noteEl = document.createElement("div");
          noteEl.textContent = "Tomorrow: " + entry.note;
          div.appendChild(noteEl);
        }

        container.appendChild(div);
      });
    }

    function renderStreak() {
      const streakText = document.getElementById("streakText");
      if (!streakText) return;

      const log = getLog();
      const streak = computeStreakFromLog(log);

      if (streak === 0) {
        streakText.textContent = "Current streak: 0 days.";
      } else if (streak === 1) {
        streakText.textContent = "Current streak: 1 day of posture.";
      } else {
        streakText.textContent = "Current streak: " + streak + " days of posture.";
      }
    }

    function computeScore() {
      let score = 0;

      checkboxFields.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.checked) score += 1;
      });

      const text = document.getElementById("selfImprove");
      if (text && text.value.trim().length > 0) score += 1;

      const bags = parseInt(localStorage.getItem("trashBags") || "0", 10);
      score += bags;

      return score;
    }

    function saveChecklist() {
      checklistFields.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;

        if (el.type === "checkbox") localStorage.setItem("ct_" + id, el.checked);
        else localStorage.setItem("ct_" + id, el.value);
      });

      const score = computeScore();
      localStorage.setItem("ct_score_today", score);

      let best = parseInt(localStorage.getItem("ct_score_best") || "0", 10);
      if (score > best) {
        best = score;
        localStorage.setItem("ct_score_best", best);
      }

      document.getElementById("scoreCurrent").innerText = score;
      document.getElementById("scoreBest").innerText = best;

      upsertTodayLog(score);
      renderLog();
      renderStreak();

      document.getElementById("saveMessage").innerText =
        (score === best) ?
        "Checklist saved ✔ New personal best." :
        "Checklist saved ✔";
    }

    function getTrashCount() {
      return parseInt(localStorage.getItem("trashBags") || "0", 10);
    }

    function setTrashCount(value) {
      if (value < 0) value = 0;
      localStorage.setItem("trashBags", value);
      const display = document.getElementById("trashCountDisplay");
      if (display) display.innerText = value;
      const msg = document.getElementById("trashMessage");
      if (msg) msg.innerText = "Updated ✔";
    }

    function incrementTrash() {
      setTrashCount(getTrashCount() + 1);
    }

    function decrementTrash() {
      setTrashCount(getTrashCount() - 1);
    }

    // Operation Journal
    function saveJournal() {
      const el = document.getElementById("opJournal");
      if (!el) return;
      localStorage.setItem("ct_journal", el.value);
      const msg = document.getElementById("journalMessage");
      if (msg) msg.innerText = "Journal saved ✔";
    }

    function loadJournal() {
      const el = document.getElementById("opJournal");
      if (!el) return;
      const stored = localStorage.getItem("ct_journal");
      if (stored !== null) el.value = stored;
    }

    // PDF overlay helpers
    function openPdfOverlay(url) {
      const overlay = document.getElementById("pdfOverlay");
      const frame = document.getElementById("pdfFrame");
      if (!overlay || !frame) return;
      frame.src = url;
      overlay.style.display = "block";
      // prevent background scrolling while PDF is open
      document.body.style.overflow = "hidden";
    }

    function closePdfOverlay() {
      const overlay = document.getElementById("pdfOverlay");
      const frame = document.getElementById("pdfFrame");
      if (!overlay || !frame) return;
      frame.src = "";
      overlay.style.display = "none";
      // restore scrolling
      document.body.style.overflow = "";
    }

    document.addEventListener("DOMContentLoaded", function() {
      const inApp = isAppMode();

      // Show private tools only in app mode
      if (inApp) {
        const priv = document.querySelector(".private-section");
        if (priv) priv.style.display = "block";
        const hint = document.getElementById("publicHint");
        if (hint) hint.style.display = "none";
      }

      // Load checklist
      checklistFields.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;

        const stored = localStorage.getItem("ct_" + id);

        if (el.type === "checkbox") el.checked = stored === "true";
        else el.value = stored || "";
      });

      // Load trash count
      const trashCount = localStorage.getItem("trashBags");
      if (trashCount !== null)
        document.getElementById("trashCountDisplay").innerText = trashCount;

      // Load score
      const savedScore = localStorage.getItem("ct_score_today");
      const savedBest = localStorage.getItem("ct_score_best");
      if (savedScore) document.getElementById("scoreCurrent").innerText = savedScore;
      if (savedBest) document.getElementById("scoreBest").innerText = savedBest;

      // Load & render log and streak
      renderLog();
      renderStreak();

      // Load journal
      loadJournal();

      // Hook up PDF overlay in app mode only
      const docLinks = document.querySelectorAll(".doc-link");
      if (inApp) {
        docLinks.forEach(link => {
          link.addEventListener("click", function(e) {
            e.preventDefault();
            const url = link.getAttribute("data-doc") || link.href;
            openPdfOverlay(url);
          });
        });
      }

      const closeBtn = document.getElementById("pdfClose");
      if (closeBtn) {
        closeBtn.addEventListener("click", closePdfOverlay);
      }

      // Register service worker (safe no-op if missing)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js").catch(() => {});
      }
    });
  </script>

</body>
</html>
