<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Common Thread Â· Field Kit</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/IMG_8375.png">

  <!-- Shared styles -->
  <link rel="stylesheet" href="style.css">

  <style>
    /* Minimal structural styles only â€” enhanced in Part 2 */
    #publicView { display: none; }
    #appView { display: none; }

    .top-nav {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      gap: 0.4rem;
      padding: 0.5rem;
      background: rgba(0,0,0,0.95);
      border-bottom: 1px solid #333;
    }

    .top-nav button {
      border: 1px solid #333;
      border-radius: 10px;
      padding: 0.35rem 0.6rem;
      background: rgba(255,255,255,0.06);
      color: #fff;
      opacity: 0.85;
    }

    .top-nav button.active {
      opacity: 1;
      border-color: #666;
    }

    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>

<body>
  <header id="top">
    <h1>Common Thread Â· Field Kit</h1>
    <p>Quiet operations for responsible citizens.</p>
  </header>

  <section class="content-box">

    <!-- ===============================
         PUBLIC VIEW (Web / install)
    ================================ -->
    <div id="publicView">
      <h2>Use the Field Kit as an App</h2>
      <p class="small-note">
        Install to your Home Screen. No accounts. No tracking.
        Operator tools appear only in the installed app.
      </p>

      <p><strong>iPhone / iPad:</strong><br>
        Safari â†’ Share â†’ Add to Home Screen
      </p>

      <p><strong>Android:</strong><br>
        Chrome â†’ Menu â†’ Install App
      </p>

      <p class="small-note">
        After install, open from your Home Screen icon.
      </p>
    </div>

    <!-- ===============================
         APP VIEW (PWA only)
    ================================ -->
    <div id="appView">

      <nav class="top-nav">
        <button data-page="page-home" class="active">Home</button>
        <button data-page="page-docs">Docs</button>
        <button data-page="page-tools">Tools</button>
        <button data-page="page-games">Games</button>
        <button data-page="page-journal">Journal</button>
        <button data-page="page-groups">Groups</button>
      </nav>

      <div id="page-home" class="page active">
        <h2>Operator Status</h2>
        <p class="small-note">Local-only. Nothing leaves this device.</p>

        <div style="text-align:center;">
          <div class="small-note">CURRENT SCORE</div>
          <div id="scoreCurrent" style="font-size:2.2rem;font-weight:bold;">0</div>

          <div class="small-note">PERSONAL BEST</div>
          <div id="scoreBest" style="font-size:1.4rem;font-weight:bold;">0</div>
        </div>

        <p id="streakText" class="small-note"></p>
      </div>

      <!-- Remaining pages injected by Parts 2 & 3 -->

    </div><!-- /appView -->

  </section>

  <script>
    /* =====================================================
       CORE MODE / BOOTSTRAP (SINGLE SOURCE OF TRUTH)
       Parts 2 & 3 MUST NOT add DOMContentLoaded
    ====================================================== */

    function isAppMode() {
      return (
        (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
        window.navigator.standalone === true
      );
    }

    function showPublic() {
      document.getElementById("publicView").style.display = "block";
      document.getElementById("appView").style.display = "none";
    }

    function showApp() {
      document.getElementById("publicView").style.display = "none";
      document.getElementById("appView").style.display = "block";
    }

    function setActivePage(pageId) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      const page = document.getElementById(pageId);
      if (page) page.classList.add("active");

      document.querySelectorAll(".top-nav button").forEach(b => b.classList.remove("active"));
      const btn = document.querySelector(`.top-nav button[data-page="${pageId}"]`);
      if (btn) btn.classList.add("active");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const inApp = isAppMode();

      if (inApp) {
        showApp();

        // ðŸ”Œ Hooks implemented in Part 2 & Part 3
        if (window.initDeepLinkAndLastTab) initDeepLinkAndLastTab();
        if (window.initPdfOverlayBindings) initPdfOverlayBindings();
        if (window.initOperatorKit) initOperatorKit();

      } else {
        showPublic();
      }

      // Navigation wiring (safe, single attach)
      const nav = document.querySelector(".top-nav");
      if (nav) {
        nav.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-page]");
          if (!btn) return;
          setActivePage(btn.getAttribute("data-page"));
        });
      }
    });
  </script>

<!-- PART 2 WILL CONTINUE BELOW --><!-- =========================
     PART 2 START
========================= -->

<style>
  /* ============================
     PART 2 â€” PREMIUM APP UI LAYER
     (keeps your site style.css intact,
      but makes the Field Kit feel like a product)
  ============================ */

  /* Overall app feel */
  body {
    background: #000; /* keep dark app tone */
    color: #fff;
  }

  header#top {
    background: #000;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    padding: 18px 16px 12px;
    text-align: left;
  }

  header#top h1 {
    font-size: 18px;
    letter-spacing: 0.3px;
    margin: 0;
  }

  header#top p {
    margin-top: 6px;
    opacity: 0.72;
    font-size: 13px;
  }

  /* Make content-box dark for app */
  .content-box {
    background: transparent;
    box-shadow: none;
    border-radius: 0;
    max-width: 980px;
    padding: 14px 12px 80px;
    margin: 0 auto;
    color: #fff;
  }

  .small-note { font-size: 0.85rem; opacity: 0.72; line-height: 1.35; }

  /* Card system */
  .card {
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 14px;
    padding: 14px;
    margin: 12px 0;
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(6px);
  }

  .card h2 { margin: 0 0 8px 0; font-size: 18px; }
  .card h3 { margin: 14px 0 8px 0; font-size: 15px; opacity: 0.95; }

  .row { display:flex; gap:.55rem; flex-wrap:wrap; align-items:center; }

  input[type="text"], input[type="number"], textarea {
    padding: 0.55rem 0.65rem;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.05);
    color: #fff;
    outline: none;
    min-width: 220px;
    flex: 1;
  }

  textarea { width: 100%; min-width: 100%; }

  button {
    border: 1px solid rgba(255,255,255,0.14);
    border-radius: 12px;
    padding: 0.55rem 0.75rem;
    background: rgba(255,255,255,0.06);
    color: #fff;
    cursor: pointer;
    transition: transform 0.08s ease, opacity 0.2s ease, border-color 0.2s ease;
  }

  button:active { transform: scale(0.99); }
  button:hover { opacity: 0.95; border-color: rgba(255,255,255,0.28); }

  button.primary {
    background: rgba(255,255,255,0.14);
    border-color: rgba(255,255,255,0.26);
    font-weight: 800;
  }

  a { color: #fff; opacity: 0.9; }
  a:hover { opacity: 1; }

  hr { border: none; border-top: 1px solid rgba(255,255,255,0.10); margin: 14px 0; }

  /* Tags */
  .tag {
    display:inline-block;
    padding: 0.15rem 0.5rem;
    border: 1px solid rgba(255,255,255,0.14);
    border-radius: 999px;
    font-size: 0.75rem;
    opacity: 0.85;
    background: rgba(255,255,255,0.05);
  }

  /* Chat */
  .chat-box {
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    padding: 12px;
    background: rgba(0,0,0,0.22);
  }

  .chat-stream {
    max-height: 280px;
    overflow: auto;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    padding: 10px;
    background: rgba(0,0,0,0.25);
    font-size: 0.92rem;
    line-height: 1.25;
  }

  .chat-msg {
    border-top: 1px solid rgba(255,255,255,0.08);
    padding: 0.55rem 0;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .chat-msg:first-child { border-top: none; }

  /* Zone styles used by ladder (Part 3 initializes logic) */
  .ladder-result.zone-red { border-color: rgba(255,80,80,0.55) !important; background: rgba(255,80,80,0.10) !important; }
  .ladder-result.zone-yellow { border-color: rgba(255,200,80,0.55) !important; background: rgba(255,200,80,0.10) !important; }
  .ladder-result.zone-green { border-color: rgba(80,255,140,0.45) !important; background: rgba(80,255,140,0.10) !important; }

  /* ========= PDF Overlay (kills iOS scroll pain) ========= */
  #pdfOverlay {
    position: fixed;
    inset: 0;
    z-index: 99999;
    display: none;
    background: rgba(0,0,0,0.92);
  }

  #pdfOverlay.active { display: block; }

  #pdfOverlay .pdf-bar {
    position: sticky;
    top: 0;
    z-index: 2;
    display: flex;
    gap: 0.5rem;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.96);
  }

  #pdfOverlay .pdf-title {
    font-size: 0.9rem;
    opacity: 0.9;
    font-weight: 800;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 62vw;
  }

  #pdfOverlay .pdf-actions {
    display: flex;
    gap: 0.45rem;
    align-items: center;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  #pdfOverlay .pdf-frame-wrap {
    height: calc(100dvh - 56px);
    overflow: hidden;
  }

  #pdfOverlay iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: #111;
  }

  /* Mobile polish */
  @media (max-width: 700px) {
    .content-box { padding: 12px 10px 96px; }
    #pdfOverlay .pdf-title { max-width: 52vw; }
  }
</style>

<script>
/* =====================================================
   PART 2 â€” Page shells + Docs overlay + Deep links
   No DOMContentLoaded here â€” Part 1 calls these.
===================================================== */

(function(){
  // expose functions for Part 1 boot
  window.initDeepLinkAndLastTab = initDeepLinkAndLastTab;
  window.initPdfOverlayBindings = initPdfOverlayBindings;

  // ---------- Add the missing page shells (only once) ----------
  ensurePageShellsExist();
  ensurePdfOverlayExists();

  function ensurePageShellsExist(){
    // If pages already exist, do nothing.
    const mustExist = ["page-docs","page-tools","page-games","page-journal","page-groups"];
    const already = mustExist.every(id => document.getElementById(id));
    if (already) return;

    const appView = document.getElementById("appView");
    if (!appView) return;

    // Insert after home page (so ordering feels natural)
    const home = document.getElementById("page-home");
    const insertAfter = home || appView.querySelector(".top-nav");

    const wrap = document.createElement("div");
    wrap.innerHTML = `
      <div id="page-docs" class="page">
        <div class="card">
          <h2>Field Documents</h2>
          <p class="small-note">Tap any document to open it inside the app (with a back button).</p>

          <ul style="margin-left:1.2rem;">
            <li>
              <a href="docs/Fourpages.pdf" class="doc-link"
                 data-doc-title="CT-PRC-004 â€” Principles Package (4-Page Brief)">
                CT-PRC-004 â€” Principles Package (4-Page Brief)
              </a>
            </li>
            <li>
              <a href="docs/handbook.pdf" class="doc-link"
                 data-doc-title="CT-HBK-001 â€” Internal Handbook (Restricted)">
                CT-HBK-001 â€” Internal Handbook (Restricted)
              </a>
            </li>
            <li>
              <a href="docs/Fieldkit.pdf" class="doc-link"
                 data-doc-title="CT-FLD-010 â€” Field Kit (Operator Issue)">
                CT-FLD-010 â€” Field Kit (Operator Issue)
              </a>
            </li>
          </ul>

          <hr>
          <p class="small-note">
            If a PDF ever fails to render in-app, use <span class="tag">Open in New Tab</span>.
          </p>
        </div>
      </div>

      <div id="page-tools" class="page">
        <!-- Part 3 replaces the inside of this page with your full tools -->
        <div class="card">
          <h2>Tools</h2>
          <p class="small-note">Loading toolsâ€¦ (Part 3)</p>
        </div>
      </div>

      <div id="page-games" class="page">
        <!-- Part 3 replaces the inside of this page with your game -->
        <div class="card">
          <h2>Games</h2>
          <p class="small-note">Loading gamesâ€¦ (Part 3)</p>
        </div>
      </div>

      <div id="page-journal" class="page">
        <!-- Part 3 replaces the inside of this page with your journal -->
        <div class="card">
          <h2>Journal</h2>
          <p class="small-note">Loading journalâ€¦ (Part 3)</p>
        </div>
      </div>

      <div id="page-groups" class="page">
        <!-- Part 3 replaces the inside of this page with your groups sync -->
        <div class="card">
          <h2>Groups</h2>
          <p class="small-note">Loading group toolsâ€¦ (Part 3)</p>
        </div>
      </div>
    `;

    // Insert after home
    if (insertAfter && insertAfter.parentNode) {
      insertAfter.parentNode.insertBefore(wrap, insertAfter.nextSibling);
    } else {
      appView.appendChild(wrap);
    }
  }

  // ---------- PDF Overlay ----------
  function ensurePdfOverlayExists(){
    if (document.getElementById("pdfOverlay")) return;

    const overlay = document.createElement("div");
    overlay.id = "pdfOverlay";
    overlay.innerHTML = `
      <div class="pdf-bar">
        <div class="pdf-title" id="pdfTitle">Document</div>

        <div class="pdf-actions">
          <button type="button" class="primary" id="pdfCloseBtn">Back</button>
          <button type="button" id="pdfOpenTabBtn">Open in New Tab</button>
        </div>
      </div>

      <div class="pdf-frame-wrap">
        <iframe id="pdfFrame" title="Field Document" loading="lazy"></iframe>
      </div>
    `;
    document.body.appendChild(overlay);
  }

  function openPdfInOverlay(url, title){
    const overlay = document.getElementById("pdfOverlay");
    const frame = document.getElementById("pdfFrame");
    const titleEl = document.getElementById("pdfTitle");

    if (!overlay || !frame || !titleEl) return;

    titleEl.textContent = title || "Document";
    frame.src = url;
    overlay.classList.add("active");

    // Lock background scroll
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";

    // Remember last doc for re-open if needed
    try {
      sessionStorage.setItem("ct_last_doc_url", url);
      sessionStorage.setItem("ct_last_doc_title", title || "");
    } catch(e) {}
  }

  function closePdfOverlay(){
    const overlay = document.getElementById("pdfOverlay");
    const frame = document.getElementById("pdfFrame");
    if (!overlay || !frame) return;

    overlay.classList.remove("active");
    frame.src = "about:blank";

    // Restore scroll
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }

  // Called by Part 1 boot
  function initPdfOverlayBindings(){
    // Bind doc clicks (event delegation)
    document.addEventListener("click", (e) => {
      const a = e.target.closest("a.doc-link");
      if (!a) return;

      // Only intercept in-app
      if (!(window.isAppMode && window.isAppMode())) return;

      e.preventDefault();
      const url = a.getAttribute("href");
      const title = a.getAttribute("data-doc-title") || a.textContent.trim();
      openPdfInOverlay(url, title);
    });

    // Bind overlay buttons
    const closeBtn = document.getElementById("pdfCloseBtn");
    const openTabBtn = document.getElementById("pdfOpenTabBtn");

    if (closeBtn) closeBtn.addEventListener("click", closePdfOverlay);

    if (openTabBtn) {
      openTabBtn.addEventListener("click", () => {
        const frame = document.getElementById("pdfFrame");
        if (!frame || !frame.src || frame.src === "about:blank") return;
        window.open(frame.src, "_blank", "noopener");
      });
    }

    // Escape closes overlay
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const overlay = document.getElementById("pdfOverlay");
        if (overlay && overlay.classList.contains("active")) closePdfOverlay();
      }
    });
  }

  // Called by Part 1 boot
  function initDeepLinkAndLastTab(){
    // Restore last tab (app only)
    try{
      const last = localStorage.getItem("ct_last_tab");
      if (last && document.getElementById(last)) {
        window.setActivePage(last);
      }
    }catch(e){}

    // Hash routing (#docs, #tools, #games, #journal, #groups, #home)
    function routeFromHash(){
      const raw = (location.hash || "").replace("#","").trim().toLowerCase();
      const map = {
        "home":"page-home",
        "docs":"page-docs",
        "tools":"page-tools",
        "games":"page-games",
        "journal":"page-journal",
        "groups":"page-groups"
      };
      const page = map[raw];
      if (page && document.getElementById(page)) {
        window.setActivePage(page);
      }
    }

    window.addEventListener("hashchange", routeFromHash);

    // Patch setActivePage to remember last tab + keep hash in sync
    const originalSetActivePage = window.setActivePage;
    if (typeof originalSetActivePage === "function" && !window.__ctmPatchedSetActivePage) {
      window.__ctmPatchedSetActivePage = true;

      window.setActivePage = function(pageId){
        originalSetActivePage(pageId);

        try { localStorage.setItem("ct_last_tab", pageId); } catch(e){}

        const reverse = {
          "page-home":"home",
          "page-docs":"docs",
          "page-tools":"tools",
          "page-games":"games",
          "page-journal":"journal",
          "page-groups":"groups"
        };
        const h = reverse[pageId];
        if (h && ("#" + h) !== location.hash) {
          history.replaceState(null, "", "#" + h);
        }
      };
    }

    // Apply hash route on boot
    routeFromHash();
  }
})();
</script>

<!-- =========================
     PART 2 END
========================= -->

<!-- PART 3 WILL CONTINUE BELOW --><!-- =========================
     PART 3 START
========================= -->

<script>
/* =====================================================
   PART 3 â€” OPERATOR KIT CORE
   Activated ONLY by initOperatorKit() from Part 1
===================================================== */

(function(){
  // Expose initializer
  window.initOperatorKit = initOperatorKit;

  // -------------------------
  // Constants / storage keys
  // -------------------------
  const STORAGE = {
    SCORE_TODAY: "ct_score_today",
    SCORE_BEST: "ct_score_best",
    LOG: "ct_log",
    TRASH: "trashBags",
    JOURNAL: "ct_journal",
    JOURNAL_ENTRIES: "ct_journal_entries",
    LAST_MISSION_DATE: "ct_mission_date",
    LAST_MISSION_TEXT: "ct_mission_text",
    LAST_MISSION_DONE: "ct_mission_done"
  };

  const MISSIONS = [
    "Pick up trash in a place you didnâ€™t cause and leave quietly.",
    "Ask a clarifying question instead of stating an opinion.",
    "De-escalate one tense moment by slowing your voice.",
    "Defend someone from unfair treatment without attacking.",
    "Correct yourself publicly if you were wrong.",
    "Fix or clean one thing nobody asked you to fix.",
    "Choose not to post one piece of outrage content today.",
    "Support someone outside your usual circle.",
    "Repeat someoneâ€™s view back accurately before disagreeing.",
    "Leave a place better than you found it without credit."
  ];

  const QUIZ = [
    { t:"Those people are ruining everything.", c:0 },
    { t:"I disagree because I think this harms families.", c:1 },
    { t:"From their perspective this makes sense.", c:2 },
    { t:"Turnout increased by 7% this year.", c:3 }
  ];

  // -------------------------
  // Utility
  // -------------------------
  const todayKey = () => new Date().toISOString().slice(0,10);

  function getJSON(key, def){
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : def;
    } catch { return def; }
  }

  function setJSON(key, val){
    try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
  }

  // -------------------------
  // Main initializer
  // -------------------------
  function initOperatorKit(){
    buildToolsPage();
    buildGamesPage();
    buildJournalPage();
    buildGroupsPage();

    restoreScores();
    restoreJournal();
    restoreLog();
  }

  // -------------------------
  // TOOLS PAGE
  // -------------------------
  function buildToolsPage(){
    const page = document.getElementById("page-tools");
    if (!page) return;

    page.innerHTML = `
      <div class="card">
        <h2>Daily Civic Posture</h2>
        <p class="small-note">Quiet actions count. Stored locally.</p>
        <button class="primary" id="doMission">Draw Todayâ€™s Mission</button>
        <p id="missionText" class="small-note"></p>
      </div>

      <div class="card">
        <h2>Community Bags of Trash</h2>
        <div style="text-align:center">
          <div class="small-note">TOTAL</div>
          <div id="trashCount" style="font-size:2rem;font-weight:bold;">0</div>
          <button id="trashPlus">+1</button>
          <button id="trashMinus">Undo</button>
        </div>
      </div>
    `;

    // Mission
    const btn = document.getElementById("doMission");
    const txt = document.getElementById("missionText");

    btn.onclick = () => {
      const m = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
      localStorage.setItem(STORAGE.LAST_MISSION_TEXT, m);
      localStorage.setItem(STORAGE.LAST_MISSION_DATE, todayKey());
      localStorage.setItem(STORAGE.LAST_MISSION_DONE, "false");
      txt.textContent = m;
      incrementScore(1);
    };

    // Trash counter
    const updateTrash = v => {
      if (v < 0) v = 0;
      localStorage.setItem(STORAGE.TRASH, v);
      document.getElementById("trashCount").textContent = v;
    };

    document.getElementById("trashPlus").onclick = () =>
      updateTrash((+localStorage.getItem(STORAGE.TRASH)||0)+1);

    document.getElementById("trashMinus").onclick = () =>
      updateTrash((+localStorage.getItem(STORAGE.TRASH)||0)-1);

    updateTrash(+localStorage.getItem(STORAGE.TRASH)||0);
  }

  // -------------------------
  // GAMES PAGE
  // -------------------------
  function buildGamesPage(){
    const page = document.getElementById("page-games");
    if (!page) return;

    let idx = -1;

    page.innerHTML = `
      <div class="card">
        <h2>Pattern Spotter</h2>
        <p id="quizQ" class="small-note">Tap New Scenario</p>
        <div class="row">
          <button data-a="0">Instinct Spike</button>
          <button data-a="1">Grounded Disagreement</button>
          <button data-a="2">Cooling Language</button>
          <button data-a="3">Neutral Fact</button>
        </div>
        <button id="newQ">New Scenario</button>
        <p id="quizF" class="small-note"></p>
      </div>
    `;

    page.querySelector("#newQ").onclick = () => {
      idx = Math.floor(Math.random()*QUIZ.length);
      page.querySelector("#quizQ").textContent = QUIZ[idx].t;
      page.querySelector("#quizF").textContent = "";
    };

    page.querySelectorAll("button[data-a]").forEach(b=>{
      b.onclick = ()=>{
        if (idx < 0) return;
        const ok = +b.dataset.a === QUIZ[idx].c;
        page.querySelector("#quizF").textContent =
          ok ? "Correct." : "Not quite.";
      };
    });
  }

  // -------------------------
  // JOURNAL PAGE
  // -------------------------
  function buildJournalPage(){
    const page = document.getElementById("page-journal");
    if (!page) return;

    page.innerHTML = `
      <div class="card">
        <h2>Operation Journal</h2>
        <textarea id="journalInput" rows="6"></textarea>
        <button id="saveJournal">Save</button>
        <div id="journalList"></div>
      </div>
    `;

    document.getElementById("saveJournal").onclick = ()=>{
      const val = document.getElementById("journalInput").value.trim();
      if (!val) return;

      const entries = getJSON(STORAGE.JOURNAL_ENTRIES, []);
      entries.push({ t:new Date().toISOString(), v:val });
      setJSON(STORAGE.JOURNAL_ENTRIES, entries.slice(-30));
      document.getElementById("journalInput").value = "";
      restoreJournal();
    };
  }

  function restoreJournal(){
    const list = document.getElementById("journalList");
    if (!list) return;
    const entries = getJSON(STORAGE.JOURNAL_ENTRIES, []);
    list.innerHTML = entries.slice().reverse().map(e=>`
      <div class="log-entry">
        <div class="log-entry-date">${new Date(e.t).toLocaleString()}</div>
        <div class="log-entry-meta">${e.v}</div>
      </div>
    `).join("");
  }

  // -------------------------
  // GROUPS PAGE (stub safe)
  // -------------------------
  function buildGroupsPage(){
    const page = document.getElementById("page-groups");
    if (!page) return;

    page.innerHTML = `
      <div class="card">
        <h2>Groups</h2>
        <p class="small-note">
          Group sync is handled by the Cloudflare Worker.
          This UI is intentionally minimal and offline-safe.
        </p>
      </div>
    `;
  }

  // -------------------------
  // SCORE / LOG
  // -------------------------
  function incrementScore(v){
    let s = +localStorage.getItem(STORAGE.SCORE_TODAY)||0;
    s += v;
    localStorage.setItem(STORAGE.SCORE_TODAY, s);

    let best = +localStorage.getItem(STORAGE.SCORE_BEST)||0;
    if (s > best){
      best = s;
      localStorage.setItem(STORAGE.SCORE_BEST, best);
    }

    const sc = document.getElementById("scoreCurrent");
    const sb = document.getElementById("scoreBest");
    if (sc) sc.textContent = s;
    if (sb) sb.textContent = best;

    upsertLog(s);
  }

  function upsertLog(score){
    const log = getJSON(STORAGE.LOG, []);
    const d = todayKey();
    const idx = log.findIndex(e=>e.d===d);
    if (idx>=0) log[idx].s = score;
    else log.push({ d, s:score });
    setJSON(STORAGE.LOG, log.slice(-30));
  }

  function restoreLog(){
    const log = getJSON(STORAGE.LOG, []);
    if (!log.length) return;
    const last = log[log.length-1];
    if (last){
      const sc = document.getElementById("scoreCurrent");
      if (sc) sc.textContent = last.s;
    }
  }

  function restoreScores(){
    const sc = document.getElementById("scoreCurrent");
    const sb = document.getElementById("scoreBest");
    if (sc) sc.textContent = localStorage.getItem(STORAGE.SCORE_TODAY)||0;
    if (sb) sb.textContent = localStorage.getItem(STORAGE.SCORE_BEST)||0;
  }

})();
</script>

<!-- =========================
     PART 3 END
========================= -->
