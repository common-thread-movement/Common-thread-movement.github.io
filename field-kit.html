<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Common Thread · Field Kit</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- App icon for iOS Home Screen -->
  <link rel="apple-touch-icon" href="icons/IMG_8375.png">

  <!-- Your existing site styles -->
  <link rel="stylesheet" href="style.css">

  <style>
    /* Hide private tools by default */
    .private-section {
      display: none;
    }

    .small-note {
      font-size: 0.8rem;
      opacity: 0.65;
    }

    .log-entry {
      border-top: 1px solid #444;
      padding: 0.4rem 0;
      font-size: 0.85rem;
    }
    .log-entry-date {
      font-weight: bold;
      opacity: 0.9;
    }
    .log-entry-meta {
      opacity: 0.8;
    }

    .mission-card {
      border: 1px solid #444;
      padding: 0.6rem;
      border-radius: 4px;
      margin: 0.4rem 0 0.6rem 0;
      font-size: 0.9rem;
      background: rgba(0,0,0,0.25);
    }

    .quiz-question {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .quiz-options button {
      display: block;
      width: 100%;
      margin-bottom: 0.3rem;
    }

    /* PDF overlay viewer */
    .pdf-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      z-index: 9999;
    }

    .pdf-overlay.hidden {
      display: none;
    }

    .pdf-toolbar {
      background: #111;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .pdf-toolbar button {
      cursor: pointer;
    }

    .pdf-container {
      flex: 1;
      overflow: hidden;
    }

    .pdf-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #222;
    }

    /* Simple bottom navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 0.4rem 0.2rem;
      background: rgba(0,0,0,0.95);
      border-top: 1px solid #333;
      font-size: 0.8rem;
      z-index: 5000;
    }

    .bottom-nav a {
      text-decoration: none;
      color: #ffffff;
      opacity: 0.8;
    }

    .bottom-nav a:active,
    .bottom-nav a:focus {
      opacity: 1;
    }
  </style>
</head>

<body id="top">

  <header>
    <h1>Common Thread · Field Kit</h1>
    <p>Quiet operations for responsible citizens.</p>
  </header>

  <!-- PDF overlay viewer -->
  <div id="pdfOverlay" class="pdf-overlay hidden">
    <div class="pdf-toolbar">
      <button type="button" onclick="closePdf()">← Back</button>
      <span id="pdfTitleBar"></span>
    </div>
    <div class="pdf-container">
      <iframe id="pdfFrame" title="Field document" loading="lazy"></iframe>
    </div>
  </div>

  <section class="content-box">

    <!-- ========== DOCUMENT LINKS ========== -->
    <h2 id="docs">Field Documents</h2>
    <p style="margin-bottom: 0.5rem;">Tap any document below to open it:</p>

    <ul>
      <li>
        <a href="docs/Fourpages.pdf"
           onclick="if (window.openPdf) { openPdf('docs/Fourpages.pdf','CT-PRC-004 — Principles Package (4-Page Brief)'); return false; }">
          CT-PRC-004 — Principles Package (4-Page Brief)
        </a>
      </li>
      <li>
        <a href="docs/handbook.pdf"
           onclick="if (window.openPdf) { openPdf('docs/handbook.pdf','CT-HBK-001 — Internal Handbook (Restricted)'); return false; }">
          CT-HBK-001 — Internal Handbook (Restricted)
        </a>
      </li>
      <li>
        <a href="docs/Fieldkit.pdf"
           onclick="if (window.openPdf) { openPdf('docs/Fieldkit.pdf','CT-FLD-010 — Field Kit (Operator Issue)'); return false; }">
          CT-FLD-010 — Field Kit (Operator Issue)
        </a>
      </li>
    </ul>

    <!-- ========== BATHROOM RITUAL CHECKLIST ========== -->
    <hr>

    <h2>Bathroom Clean-Up Ritual</h2>
    <p class="small-note">
      A simple ritual any operator can run anywhere: leave shared spaces better than you found them.
    </p>
    <ul>
      <li>Pick up visible trash (paper towels, cups, wrappers).</li>
      <li>Wipe the sink and surrounding counter so it’s visibly cleaner.</li>
      <li>Check the mirror and floor; remove obvious mess if safe to do so.</li>
      <li>Make sure lights, water, and dispensers are left in a sane, respectful state.</li>
      <li>Leave without announcing it. The point is posture, not credit.</li>
    </ul>

    <!-- ========== DIRECTIONS SECTION FOR INSTALLING APP ========== -->
    <hr>

    <h2>Use the Field Kit as an App</h2>

    <p class="small-note">
      Installing this page to your Home Screen lets the operator tools run like a quiet, offline app.
      All data stays on your device.
    </p>

    <p>
      <strong>On iPhone / iPad:</strong><br>
      1. Open this page in Safari.<br>
      2. Tap the Share icon (square with the arrow).<br>
      3. Scroll down and tap <strong>Add to Home Screen</strong>.<br>
      4. Tap <strong>Add</strong>. Use the new icon to open the Field Kit.
    </p>

    <p>
      <strong>On Android (Chrome):</strong><br>
      1. Open this page in Chrome.<br>
      2. Tap the menu (⋮) in the top-right corner.<br>
      3. Tap <strong>Add to Home screen</strong> or <strong>Install app</strong>.<br>
      4. Confirm. Use the new icon to open the Field Kit.
    </p>

    <p id="publicHint" class="small-note" style="margin-top:1rem; text-align:center;">
      Operator tools are available when opened from your Home Screen as an app.
    </p>

    <!-- ========== PRIVATE OPERATOR TOOLS (HIDDEN ON NORMAL WEBSITE) ========== -->
    <div class="private-section" id="privateTools">

      <hr>

      <!-- ========== DAILY CIVIC POSTURE CHECKLIST ========== -->
      <h2 id="tools">Daily Civic Posture Checklist</h2>

      <form id="dailyChecklist">

        <h3>Grounding</h3>
        <label><input type="checkbox" id="grounding1"> Did I take 3 seconds before responding?</label><br>
        <label><input type="checkbox" id="grounding2"> Did I observe instead of react at least once?</label>

        <h3>Truth Discipline</h3>
        <label><input type="checkbox" id="truth1"> Did I avoid sharing anything unverified?</label><br>
        <label><input type="checkbox" id="truth2"> Did I admit "I don't know" when needed?</label><br>
        <label><input type="checkbox" id="truth3"> Did I correct myself or my "side" if wrong?</label>

        <h3>Non-Tribal Posture</h3>
        <label><input type="checkbox" id="nontribal1"> Did I disagree respectfully with someone today?</label><br>
        <label><input type="checkbox" id="nontribal2"> Did I treat people as humans, not camp avatars?</label>

        <h3>De-Escalation</h3>
        <label><input type="checkbox" id="deesc1"> Did I cool down at least one rising situation?</label><br>
        <label><input type="checkbox" id="deesc2"> Did I avoid fueling any conflict?</label>

        <h3>Quiet Uplift</h3>
        <label><input type="checkbox" id="uplift1"> Did I do one helpful act without telling anyone?</label><br>
        <label><input type="checkbox" id="uplift2"> Did I support someone quietly who needed it?</label>

        <h3>Boundary Health</h3>
        <label><input type="checkbox" id="boundary1"> Did I maintain realistic boundaries?</label><br>
        <label><input type="checkbox" id="boundary2"> Did I avoid guilt/pressure from moving me out of position?</label>

        <h3>Operator Integrity</h3>
        <label><input type="checkbox" id="integrity1"> Did I act within the law?</label><br>
        <label><input type="checkbox" id="integrity2"> Did I avoid anything harmful to the movement?</label><br>
        <label><input type="checkbox" id="integrity3"> Did I remain nonpartisan, nonviolent, grounded?</label>

        <h3>Final Self-Audit</h3>
        <label>What one thing will I improve tomorrow?</label><br>
        <textarea id="selfImprove" rows="3" style="width:100%;"></textarea>

        <br><br>
        <button type="button" onclick="saveChecklist()">Save Today's Checklist</button>
      </form>

      <p id="saveMessage" style="color:#5f5; font-weight:bold;"></p>

      <hr>

      <!-- ========== COMMUNITY BAGS OF TRASH COUNTER ========== -->
      <h2>Community Bags of Trash</h2>

      <div style="text-align:center; margin-bottom: 1rem;">
        <div style="font-size:0.85rem; opacity:0.7;">TOTAL BAGS RECORDED</div>
        <div id="trashCountDisplay" style="font-size:2rem; font-weight:bold;">0</div>
        <button type="button" onclick="incrementTrash()">+1 Bag</button>
        <button type="button" onclick="decrementTrash()" style="margin-left:0.5rem;">Undo (–1)</button>
      </div>

      <p id="trashMessage" style="color:#5f5; font-weight:bold; text-align:center;"></p>

      <hr>

      <!-- ========== TODAY'S SCORE ========== -->
      <h2>Today’s Score</h2>

      <div style="text-align:center;">
        <div style="font-size:0.85rem; opacity:0.7;">CURRENT SCORE</div>
        <div id="scoreCurrent" style="font-size:2.2rem; font-weight:bold;">0</div>

        <div style="font-size:0.85rem; opacity:0.7;">PERSONAL BEST</div>
        <div id="scoreBest" style="font-size:1.4rem; font-weight:bold;">0</div>
      </div>

      <hr>

      <!-- ========== DAILY MISSION CARD GAME ========== -->
      <h2>Daily Mission Card</h2>
      <p class="small-note">
        One quiet operation for today. Completing it adds to your score. Missions reset each day.
      </p>

      <div id="missionCard" class="mission-card">
        <span id="missionText">Tap "Draw Today’s Mission" to begin.</span>
      </div>

      <button type="button" onclick="drawMission()">Draw Today’s Mission</button>
      <button type="button" onclick="completeMission()" style="margin-left:0.5rem;">
        Mark Mission Complete
      </button>
      <p id="missionStatus" class="small-note" style="margin-top:0.4rem;"></p>

      <hr>

      <!-- ========== AMYGDALA DRILL ========== -->
      <h2>Amygdala Drill — 60-Second Reset</h2>
      <p class="small-note">
        CTM term: “Amygdala Drill” — a one-minute reset to catch fight/flight and choose conscience instead.
      </p>
      <div id="amygdalaStep" class="small-note" style="margin-bottom:0.4rem;">
        Press start when you feel the Instinct Spike.
      </div>
      <div id="amygdalaTimer" style="font-size:1.4rem; font-weight:bold; margin-bottom:0.4rem;">
        Ready
      </div>
      <button type="button" onclick="startAmygdala()">Start 60-second drill</button>
      <p id="amygdalaNote" class="small-note" style="margin-top:0.4rem;"></p>

      <hr>

      <!-- ========== PATTERN SPOTTER — INSTINCT SPIKE GAME ========== -->
      <h2 id="games">Pattern Spotter — Instinct Spike</h2>
      <p class="small-note">
        Quick drills to spot Instinct Spike language (amygdala flare) versus grounded or cooling CT posture.
      </p>

      <div id="quizQuestion" class="quiz-question"></div>
      <div class="quiz-options">
        <button type="button" onclick="answerQuiz(0)">Instinct Spike / tribal escalation</button>
        <button type="button" onclick="answerQuiz(1)">Grounded disagreement</button>
        <button type="button" onclick="answerQuiz(2)">Cooling / de-escalation</button>
        <button type="button" onclick="answerQuiz(3)">Neutral / factual</button>
      </div>
      <p id="quizFeedback" class="small-note" style="margin-top:0.4rem;"></p>
      <button type="button" onclick="nextQuiz()" style="margin-top:0.4rem;">New Scenario</button>

      <hr>

      <!-- ========== OPERATOR LOG + STREAK ========== -->
      <h2>Operator Log</h2>
      <p class="small-note">
        Local record of recent days: score, bags, and tomorrow’s focus. Stored only on this device.
      </p>

      <p class="small-note" id="streakText"></p>

      <div id="logContainer"></div>

      <hr>

      <!-- ========== OPERATION JOURNAL ========== -->
      <h2 id="journalSection">Operation Journal</h2>
      <p class="small-note">
        Free-form notes on conversations, situations, and observations. Saved only on this device.
      </p>

      <textarea id="opJournal" rows="6" style="width:100%;"></textarea>
      <br><br>
      <button type="button" onclick="saveJournal()">Save Journal</button>
      <p id="journalMessage" style="color:#5f5; font-weight:bold;"></p>

    </div> <!-- END PRIVATE SECTION -->

  </section>

  <!-- Bottom navigation -->
  <nav class="bottom-nav">
    <a href="#top">Top</a>
    <a href="#docs">Docs</a>
    <a href="#tools">Tools</a>
    <a href="#games">Games</a>
    <a href="#journalSection">Journal</a>
  </nav>

  <!-- ========== SCRIPT ========== -->
  <script>
    // PDF viewer controls
    function openPdf(path, title) {
      var overlay = document.getElementById("pdfOverlay");
      var frame = document.getElementById("pdfFrame");
      var titleBar = document.getElementById("pdfTitleBar");
      if (!overlay || !frame || !titleBar) return;

      frame.src = path;
      titleBar.textContent = title || path.split("/").pop();
      overlay.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closePdf() {
      var overlay = document.getElementById("pdfOverlay");
      var frame = document.getElementById("pdfFrame");
      if (!overlay || !frame) return;

      frame.src = "";
      overlay.classList.add("hidden");
      document.body.style.overflow = "";
    }

    // Determine if running as installed app (iOS + general)
    function isAppMode() {
      const standaloneMatch = window.matchMedia &&
        window.matchMedia('(display-mode: standalone)').matches;
      const iosStandalone = window.navigator.standalone === true;
      return standaloneMatch || iosStandalone;
    }

    // Checklist items
    const checklistFields = [
      "grounding1","grounding2",
      "truth1","truth2","truth3",
      "nontribal1","nontribal2",
      "deesc1","deesc2",
      "uplift1","uplift2",
      "boundary1","boundary2",
      "integrity1","integrity2","integrity3",
      "selfImprove"
    ];
    const checkboxFields = checklistFields.slice(0,16); // first 16 are checkboxes

    // Daily Mission data
    const MISSIONS = [
      "Pick up trash in a spot that bothers you and leave without posting about it.",
      "Defend someone you disagree with from unfair treatment or mockery.",
      "Ask one person a curious question instead of arguing your point.",
      "Quietly fix or clean one thing nobody asked you to touch.",
      "Clarify someone’s position before you criticize it: repeat it back fairly first.",
      "Offer a sincere compliment to someone outside your usual circle or tribe.",
      "De-escalate one tense moment by lowering your tone and pace.",
      "Admit one small fault today without blame-shifting or excuse.",
      "Choose not to share one piece of outrage content you normally would.",
      "Support someone’s good idea even if they’re from a different camp than you."
    ];

    // Amygdala Drill steps
    const AMYGDALA_STEPS = [
      "0–15s: Notice what you’re feeling. Name it without judging it.",
      "15–30s: Notice where you feel it in your body. Just observe.",
      "30–45s: Ask: What would my best self want to do here?",
      "45–60s: Choose one small, grounded action you can take next."
    ];
    let amygdalaInterval = null;

    // Pattern Spotter questions
    const QUIZ_QUESTIONS = [
      {
        text: "\"Those people are destroying everything.\"",
        correct: 0,
        explanation:
          "This is Instinct Spike / tribal escalation: it collapses complex people into a hostile camp."
      },
      {
        text: "\"I don’t like this policy because I think it harms working families.\"",
        correct: 1,
        explanation:
          "This is grounded disagreement: specific concern, not an attack on a tribe."
      },
      {
        text: "\"From their point of view, this actually makes sense even if I disagree.\"",
        correct: 2,
        explanation:
          "This is cooling language: it lowers Instinct Spike by humanizing the other side."
      },
      {
        text: "\"The report says turnout increased by 7% this year.\"",
        correct: 3,
        explanation:
          "This is neutral / factual language: it can be used well or badly, but isn’t Instinct Spike by itself."
      },
      {
        text: "\"Anyone who disagrees with this is either stupid or evil.\"",
        correct: 0,
        explanation:
          "Classic Instinct Spike pattern: moral condemnation of a whole category of people."
      },
      {
        text: "\"I’m angry, but I want to understand what you were trying to do.\"",
        correct: 2,
        explanation:
          "Cooling / de-escalation: acknowledges emotion while steering toward understanding."
      },
      {
        text: "\"They always play the victim.\"",
        correct: 0,
        explanation:
          "Instinct Spike: broad, contemptuous generalization about a group."
      },
      {
        text: "\"Here’s what I heard you say; tell me if I’m missing anything.\"",
        correct: 2,
        explanation:
          "Cooling posture: slows things down and checks understanding instead of reacting."
      }
    ];
    let currentQuizIndex = -1;

    function todayKey() {
      return new Date().toISOString().slice(0,10); // YYYY-MM-DD
    }

    // ---- Log utilities ----
    function getLog() {
      try {
        const raw = localStorage.getItem("ct_log");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        return [];
      }
    }

    function setLog(entries) {
      localStorage.setItem("ct_log", JSON.stringify(entries));
    }

    function upsertTodayLog(score) {
      const date = todayKey();
      const bags = parseInt(localStorage.getItem("trashBags") || "0", 10);
      const noteEl = document.getElementById("selfImprove");
      const note = noteEl ? noteEl.value.trim() : "";

      let log = getLog();
      const idx = log.findIndex(e => e.date === date);
      const entry = { date, score, bags, note };

      if (idx >= 0) log[idx] = entry;
      else log.push(entry);

      log.sort((a, b) => a.date.localeCompare(b.date));

      if (log.length > 30) {
        log = log.slice(log.length - 30);
      }

      setLog(log);
    }

    function computeStreakFromLog(log) {
      if (!log.length) return 0;

      const map = {};
      log.forEach(e => { map[e.date] = e.score; });

      let streak = 0;
      let cursor = new Date(todayKey());

      while (true) {
        const key = cursor.toISOString().slice(0,10);
        if (!map[key] || map[key] <= 0) break;
        streak += 1;
        cursor.setDate(cursor.getDate() - 1);
      }

      return streak;
    }

    function renderLog() {
      const container = document.getElementById("logContainer");
      if (!container) return;

      const log = getLog().slice().sort((a, b) => b.date.localeCompare(a.date));

      if (!log.length) {
        container.innerHTML = "<p class='small-note'>No entries yet.</p>";
        return;
      }

      const recent = log.slice(0, 14);
      container.innerHTML = "";
      recent.forEach(entry => {
        const div = document.createElement("div");
        div.className = "log-entry";

        const dateEl = document.createElement("div");
        dateEl.className = "log-entry-date";
        dateEl.textContent = entry.date;

        const metaEl = document.createElement("div");
        metaEl.className = "log-entry-meta";
        metaEl.textContent = "Score: " + entry.score + " · Bags: " + entry.bags;

        div.appendChild(dateEl);
        div.appendChild(metaEl);

        if (entry.note) {
          const noteEl = document.createElement("div");
          noteEl.textContent = "Tomorrow: " + entry.note;
          div.appendChild(noteEl);
        }

        container.appendChild(div);
      });
    }

    function renderStreak() {
      const streakText = document.getElementById("streakText");
      if (!streakText) return;

      const log = getLog();
      const streak = computeStreakFromLog(log);

      if (streak === 0) {
        streakText.textContent = "Current streak: 0 days.";
      } else if (streak === 1) {
        streakText.textContent = "Current streak: 1 day of posture.";
      } else {
        streakText.textContent = "Current streak: " + streak + " days of posture.";
      }
    }

    // ---- Score computation ----
    function computeScore() {
      let score = 0;

      // Checkboxes
      checkboxFields.forEach(function(id) {
        const el = document.getElementById(id);
        if (el && el.checked) score += 1;
      });

      // Self-improvement note
      const text = document.getElementById("selfImprove");
      if (text && text.value.trim().length > 0) score += 1;

      // Bags of trash
      const bags = parseInt(localStorage.getItem("trashBags") || "0", 10);
      score += bags;

      // Mission completion (1 point if completed)
      const missionDone = localStorage.getItem("ct_mission_done") === "true";
      if (missionDone) score += 1;

      return score;
    }

    function saveChecklist() {
      // Save checklist + note
      checklistFields.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === "checkbox") {
          localStorage.setItem("ct_" + id, el.checked);
        } else {
          localStorage.setItem("ct_" + id, el.value);
        }
      });

      // Compute + save score
      const score = computeScore();
      localStorage.setItem("ct_score_today", score);

      let best = parseInt(localStorage.getItem("ct_score_best") || "0", 10);
      if (score > best) {
        best = score;
        localStorage.setItem("ct_score_best", best);
      }

      document.getElementById("scoreCurrent").innerText = score;
      document.getElementById("scoreBest").innerText = best;

      // Update log + streak
      upsertTodayLog(score);
      renderLog();
      renderStreak();

      document.getElementById("saveMessage").innerText =
        (score === best) ?
        "Checklist saved ✔ New personal best." :
        "Checklist saved ✔";
    }

    // ---- Trash counter ----
    function getTrashCount() {
      return parseInt(localStorage.getItem("trashBags") || "0", 10);
    }

    function setTrashCount(value) {
      if (value < 0) value = 0;
      localStorage.setItem("trashBags", value);
      const display = document.getElementById("trashCountDisplay");
      if (display) display.innerText = value;
      const msg = document.getElementById("trashMessage");
      if (msg) msg.innerText = "Updated ✔";
    }

    function incrementTrash() {
      setTrashCount(getTrashCount() + 1);
    }

    function decrementTrash() {
      setTrashCount(getTrashCount() - 1);
    }

    // ---- Operation Journal ----
    function saveJournal() {
      const el = document.getElementById("opJournal");
      if (!el) return;
      localStorage.setItem("ct_journal", el.value);
      const msg = document.getElementById("journalMessage");
      if (msg) msg.innerText = "Journal saved ✔";
    }

    function loadJournal() {
      const el = document.getElementById("opJournal");
      if (!el) return;
      const stored = localStorage.getItem("ct_journal");
      if (stored !== null) el.value = stored;
    }

    // ---- Daily Mission game ----
    function loadMissionFromStorage() {
      const date = localStorage.getItem("ct_mission_date");
      const text = localStorage.getItem("ct_mission_text");
      const done = localStorage.getItem("ct_mission_done") === "true";
      const today = todayKey();

      const missionTextEl = document.getElementById("missionText");
      const missionStatusEl = document.getElementById("missionStatus");

      if (date === today && text) {
        missionTextEl.textContent = text;
        missionStatusEl.textContent = done ? "Mission marked complete for today." : "";
      } else {
        // Old mission; clear
        localStorage.removeItem("ct_mission_date");
        localStorage.removeItem("ct_mission_text");
        localStorage.removeItem("ct_mission_done");
        missionTextEl.textContent = 'Tap "Draw Today’s Mission" to begin.';
        missionStatusEl.textContent = "";
      }
    }

    function drawMission() {
      const today = todayKey();
      const randomIndex = Math.floor(Math.random() * MISSIONS.length);
      const text = MISSIONS[randomIndex];

      localStorage.setItem("ct_mission_date", today);
      localStorage.setItem("ct_mission_text", text);
      localStorage.setItem("ct_mission_done", "false");

      document.getElementById("missionText").textContent = text;
      document.getElementById("missionStatus").textContent = "Mission set for today.";

      // Recompute score (in case we removed a previously completed mission)
      const score = computeScore();
      localStorage.setItem("ct_score_today", score);
      document.getElementById("scoreCurrent").innerText = score;
    }

    function completeMission() {
      const date = localStorage.getItem("ct_mission_date");
      const today = todayKey();
      if (date !== today) {
        document.getElementById("missionStatus").textContent =
          "Draw today’s mission first.";
        return;
      }
      localStorage.setItem("ct_mission_done", "true");
      document.getElementById("missionStatus").textContent =
        "Mission marked complete for today.";

      // Recompute + save score with mission bonus
      const score = computeScore();
      localStorage.setItem("ct_score_today", score);

      let best = parseInt(localStorage.getItem("ct_score_best") || "0", 10);
      if (score > best) {
        best = score;
        localStorage.setItem("ct_score_best", best);
      }

      document.getElementById("scoreCurrent").innerText = score;
      document.getElementById("scoreBest").innerText = best;

      upsertTodayLog(score);
      renderLog();
      renderStreak();
    }

    // ---- Amygdala Drill ----
    function updateAmygdalaStep(remaining) {
      const stepEl = document.getElementById("amygdalaStep");
      if (!stepEl) return;
      if (remaining > 45) stepEl.textContent = AMYGDALA_STEPS[0];
      else if (remaining > 30) stepEl.textContent = AMYGDALA_STEPS[1];
      else if (remaining > 15) stepEl.textContent = AMYGDALA_STEPS[2];
      else stepEl.textContent = AMYGDALA_STEPS[3];
    }

    function startAmygdala() {
      const timerEl = document.getElementById("amygdalaTimer");
      const noteEl = document.getElementById("amygdalaNote");
      if (!timerEl) return;

      if (amygdalaInterval) {
        clearInterval(amygdalaInterval);
      }

      let remaining = 60;
      timerEl.textContent = remaining + "s";
      updateAmygdalaStep(remaining);

      if (noteEl) {
        noteEl.textContent =
          "You can close your eyes; the timer will run quietly. When it ends, choose one grounded action.";
      }

      amygdalaInterval = setInterval(function() {
        remaining--;
        if (remaining <= 0) {
          clearInterval(amygdalaInterval);
          amygdalaInterval = null;
          timerEl.textContent = "Done.";
          const stepEl = document.getElementById("amygdalaStep");
          if (stepEl) {
            stepEl.textContent = "Notice what changed in your body and options. Log anything important in your journal.";
          }
          if (noteEl) {
            noteEl.textContent = "If this drill helped, record the situation in your Operation Journal below.";
          }
        } else {
          timerEl.textContent = remaining + "s";
          updateAmygdalaStep(remaining);
        }
      }, 1000);
    }

    // ---- Pattern Spotter — Instinct Spike game ----
    function renderQuizQuestion() {
      const qEl = document.getElementById("quizQuestion");
      const feedbackEl = document.getElementById("quizFeedback");
      if (!qEl || !feedbackEl) return;

      if (currentQuizIndex < 0 || currentQuizIndex >= QUIZ_QUESTIONS.length) {
        qEl.textContent = 'Tap "New Scenario" to start a drill.';
        feedbackEl.textContent = "";
        return;
      }

      const q = QUIZ_QUESTIONS[currentQuizIndex];
      qEl.textContent = q.text;
      feedbackEl.textContent = "";
    }

    function nextQuiz() {
      currentQuizIndex = Math.floor(Math.random() * QUIZ_QUESTIONS.length);
      renderQuizQuestion();
    }

    function answerQuiz(choiceIndex) {
      if (currentQuizIndex < 0 || currentQuizIndex >= QUIZ_QUESTIONS.length) {
        return;
      }
      const q = QUIZ_QUESTIONS[currentQuizIndex];
      const feedbackEl = document.getElementById("quizFeedback");
      if (!feedbackEl) return;

      if (choiceIndex === q.correct) {
        feedbackEl.textContent = "Correct. " + q.explanation;
      } else {
        let label = "";
        if (choiceIndex === 0) label = "Instinct Spike / tribal escalation";
        if (choiceIndex === 1) label = "grounded disagreement";
        if (choiceIndex === 2) label = "cooling / de-escalation";
        if (choiceIndex === 3) label = "neutral / factual";
        feedbackEl.textContent =
          "Not quite (" + label + "). " + q.explanation;
      }
    }

    // ---- DOM Ready ----
    document.addEventListener("DOMContentLoaded", function() {
      const inApp = isAppMode();

      // Show private tools only in app mode
      if (inApp) {
        const priv = document.querySelector(".private-section");
        if (priv) priv.style.display = "block";
        const hint = document.getElementById("publicHint");
        if (hint) hint.style.display = "none";
      }

      // Load checklist
      checklistFields.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const stored = localStorage.getItem("ct_" + id);
        if (el.type === "checkbox") el.checked = stored === "true";
        else el.value = stored || "";
      });

      // Load trash count
      const trashCount = localStorage.getItem("trashBags");
      if (trashCount !== null) {
        const display = document.getElementById("trashCountDisplay");
        if (display) display.innerText = trashCount;
      }

      // Load score
      const savedScore = localStorage.getItem("ct_score_today");
      const savedBest = localStorage.getItem("ct_score_best");
      if (savedScore) document.getElementById("scoreCurrent").innerText = savedScore;
      if (savedBest) document.getElementById("scoreBest").innerText = savedBest;

      // Load mission
      loadMissionFromStorage();

      // Load & render log and streak
      renderLog();
      renderStreak();

      // Load journal
      loadJournal();

      // Initialize quiz
      renderQuizQuestion();

      // Register service worker (safe no-op if missing)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js").catch(function() {});
      }
    });
  </script>

</body>
</html>
